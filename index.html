<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Absensi Siswa - Dashboard Guru</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Absensi Siswa">
    <meta name="description" content="Aplikasi manajemen presensi siswa untuk guru. Kelola data siswa, input presensi, dan buat laporan dengan mudah.">
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
    <style>
        /* Core Styles */
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; }
        .touch-action-none { touch-action: none; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        /* Animations */
        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* Mobile Responsive */
        @media (max-width: 640px) {
            .mobile-padding { padding: 1rem; }
            .mobile-text { font-size: 0.875rem; }
            .mobile-button { min-height: 44px; min-width: 44px; }
        }
        /* Touch Interactions */
        .touch-card {
            transform: scale(1);
            transition: transform 0.2s ease;
        }
        .touch-card:active {
            transform: scale(0.98);
        }
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Safe Areas */
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .online { background: #10b981; color: white; }
        .offline { background: #ef4444; color: white; }
        .connecting { background: #f59e0b; color: white; }
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        .splash-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .mobile-full-width {
                width: 100% !important;
                max-width: 100% !important;
            }
            .mobile-stack {
                flex-direction: column !important;
            }
            .mobile-center {
                text-align: center !important;
            }
        }
        /* iPhone Notch Support */
        @supports (padding: max(0px)) {
            .safe-area-top {
                padding-top: max(env(safe-area-inset-top), 20px);
            }
            .safe-area-bottom {
                padding-bottom: max(env(safe-area-inset-bottom), 20px);
            }
        }
        /* Error Toast Styles */
        .error-toast {
            position: fixed;
            top: 4rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 80%;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .error-toast.show {
            transform: translateX(0);
        }
        .error-toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .error-toast-title {
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .error-toast-title i {
            margin-right: 0.5rem;
        }
        .error-toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .error-toast-message {
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-graduation-cap text-4xl"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2">Absensi Siswa</h1>
        <p class="text-blue-100">Memuat aplikasi...</p>
        <div class="mt-4">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connecting">
        <i class="fas fa-wifi mr-1"></i>
        <span>Connecting...</span>
    </div>

    <!-- Error Toast Container -->
    <div id="errorToast" class="error-toast">
        <div class="error-toast-header">
            <div class="error-toast-title">
                <i class="fas fa-exclamation-circle"></i>
                <span>Kesalahan</span>
            </div>
            <button class="error-toast-close" id="closeErrorToast">&times;</button>
        </div>
        <div class="error-toast-message" id="errorMessage"></div>
    </div>

    <!-- Mobile Header -->
    <header class="lg:hidden bg-white shadow-sm safe-area-top">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-900">Absensi Siswa</h1>
                    <p class="text-xs text-gray-500" id="currentDate"></p>
                </div>
            </div>
            <button id="profileBtn" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                <i class="fas fa-user text-gray-600 text-sm" id="mobileTeacherIcon"></i>
                <img id="mobileTeacherPhoto" class="w-full h-full object-cover hidden" alt="Foto Guru">
            </button>
        </div>
    </header>

    <div class="flex h-screen">
        <!-- Desktop Sidebar -->
        <aside class="hidden lg:flex lg:flex-col lg:w-80 bg-white shadow-lg">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Absensi Siswa</h1>
                        <p class="text-sm text-gray-500">Dashboard Guru</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="nav-item flex items-center space-x-3 p-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#students" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                    <i class="fas fa-users w-5"></i>
                    <span>Manajemen Siswa</span>
                </a>
                <a href="#attendance" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                    <i class="fas fa-check-circle w-5"></i>
                    <span>Input Presensi</span>
                </a>
                <a href="#reports" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                    <i class="fas fa-chart-bar w-5"></i>
                    <span>Rekap Presensi</span>
                </a>
                <a href="#journal" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                    <i class="fas fa-book w-5"></i>
                    <span>Rekap Jurnal</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all" id="teacherProfile">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden" id="teacherAvatar">
                        <i class="fas fa-user text-white" id="teacherIcon"></i>
                        <img id="teacherPhoto" class="w-full h-full object-cover hidden" alt="Foto Guru">
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900" id="teacherName">Guru</p>
                        <p class="text-sm text-gray-500" id="teacherSubject">Mata Pelajaran</p>
                    </div>
                    <i class="fas fa-edit text-gray-400 hover:text-gray-600"></i>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto pb-20 lg:pb-0">
            <!-- Dashboard View -->
            <div id="dashboardView" class="view-content">
                <div class="p-4 lg:p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h2>
                        <p class="text-gray-600">Ringkasan kehadiran siswa hari ini</p>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 touch-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                    <p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 touch-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Hadir Hari Ini</p>
                                    <p class="text-2xl font-bold text-green-600" id="presentToday">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 touch-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Tidak Hadir</p>
                                    <p class="text-2xl font-bold text-red-600" id="absentToday">0</p>
                                </div>
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-times-circle text-red-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 touch-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Izin/Sakit</p>
                                    <p class="text-2xl font-bold text-yellow-600" id="excusedToday">0</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-circle text-yellow-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <button class="quick-action-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl shadow-sm transition-all touch-card mobile-button">
                            <i class="fas fa-plus text-xl mb-2"></i>
                            <p class="font-medium">Input Presensi</p>
                        </button>
                        <button class="quick-action-btn bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl shadow-sm transition-all touch-card mobile-button">
                            <i class="fas fa-chart-line text-xl mb-2"></i>
                            <p class="font-medium">Lihat Rekap</p>
                        </button>
                        <button class="quick-action-btn bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-xl shadow-sm transition-all touch-card mobile-button">
                            <i class="fas fa-users text-xl mb-2"></i>
                            <p class="font-medium">Kelola Siswa</p>
                        </button>
                        <button class="quick-action-btn bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-xl shadow-sm transition-all touch-card mobile-button">
                            <i class="fas fa-book text-xl mb-2"></i>
                            <p class="font-medium">Tulis Jurnal</p>
                        </button>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Attendance Chart -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Tren Kehadiran Mingguan</h3>
                            <div class="relative h-64">
                                <canvas id="attendanceChart" class="w-full h-full"></canvas>
                            </div>
                        </div>
                        <!-- Class Performance -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Performa Kelas</h3>
                            <div class="relative h-64">
                                <canvas id="classChart" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6 border-b border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900">Aktivitas Terbaru</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4" id="recentActivity">
                                <div class="empty-state">
                                    <i class="fas fa-clock empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Aktivitas</h4>
                                    <p class="text-gray-500">Aktivitas terbaru akan muncul di sini setelah Anda mulai menggunakan aplikasi.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Management View -->
            <div id="studentsView" class="view-content hidden">
                <div class="p-4 lg:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-2xl font-bold text-gray-900">Manajemen Siswa</h2>
                            <p class="text-gray-600">Kelola data siswa dan informasi kelas</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="addStudentBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                            <button id="importStudentsBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-file-import mr-2"></i>Import Excel
                            </button>
                            <button id="exportStudentsBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-file-export mr-2"></i>Export Excel
                            </button>
                            <button id="syncStudentsBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-sync mr-2"></i>Sync Database
                            </button>
                        </div>
                    </div>

                    <!-- Class Filter -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                            <select id="classFilter" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Semua Kelas</option>
                                <option value="X-1">Kelas X-1</option>
                                <option value="X-2">Kelas X-2</option>
                                <option value="X-3">Kelas X-3</option>
                                <option value="X-4">Kelas X-4</option>
                                <option value="X-5">Kelas X-5</option>
                                <option value="X-6">Kelas X-6</option>
                                <option value="X-7">Kelas X-7</option>
                                <option value="X-8">Kelas X-8</option>
                                <option value="X-9">Kelas X-9</option>
                                <option value="X-10">Kelas X-10</option>
                                <option value="X-11">Kelas X-11</option>
                            </select>
                            <input type="text" id="searchStudent" placeholder="Cari nama atau NIS..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="text-left p-4 font-medium text-gray-900">NIS</th>
                                        <th class="text-left p-4 font-medium text-gray-900">Nama Siswa</th>
                                        <th class="text-left p-4 font-medium text-gray-900">Kelas</th>
                                        <th class="text-left p-4 font-medium text-gray-900">Kehadiran</th>
                                        <th class="text-left p-4 font-medium text-gray-900">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="5" class="p-8">
                                            <div class="empty-state">
                                                <i class="fas fa-users empty-state-icon"></i>
                                                <h4 class="text-lg font-medium text-gray-900 mb-2">Memuat data siswa...</h4>
                                                <p class="text-gray-500">Mohon tunggu sebentar</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Input View -->
            <div id="attendanceView" class="view-content hidden">
                <div class="p-4 lg:p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Input Presensi</h2>
                        <p class="text-gray-600">Catat kehadiran siswa untuk hari ini</p>
                    </div>

                    <!-- Attendance Form -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                <select id="attendanceClass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X-1">Kelas X-1</option>
                                    <option value="X-2">Kelas X-2</option>
                                    <option value="X-3">Kelas X-3</option>
                                    <option value="X-4">Kelas X-4</option>
                                    <option value="X-5">Kelas X-5</option>
                                    <option value="X-6">Kelas X-6</option>
                                    <option value="X-7">Kelas X-7</option>
                                    <option value="X-8">Kelas X-8</option>
                                    <option value="X-9">Kelas X-9</option>
                                    <option value="X-10">Kelas X-10</option>
                                    <option value="X-11">Kelas X-11</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="attendanceDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input type="text" id="attendanceSubject" placeholder="Contoh: Matematika" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button id="markAllPresent" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-check mr-2"></i>Semua Hadir
                            </button>
                            <button id="markAllAbsent" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-times mr-2"></i>Semua Tidak Hadir
                            </button>
                            <button id="copyYesterday" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-copy mr-2"></i>Salin Kemarin
                            </button>
                        </div>
                    </div>

                    <!-- Students Attendance List -->
                    <div id="attendanceList" class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6 border-b border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900">Daftar Siswa</h3>
                            <p class="text-sm text-gray-600">Pilih kelas untuk menampilkan daftar siswa</p>
                        </div>
                        <div id="attendanceStudentsList" class="p-6">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list empty-state-icon"></i>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">Pilih Kelas</h4>
                                <p class="text-gray-500">Pilih kelas dari dropdown di atas untuk menampilkan daftar siswa dan mulai input presensi.</p>
                            </div>
                        </div>
                        <div class="p-6 border-t border-gray-100">
                            <button id="saveAttendance" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-all mobile-button disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-save mr-2"></i>Simpan Presensi
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="view-content hidden">
                <div class="p-4 lg:p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Rekap Presensi</h2>
                        <p class="text-gray-600">Analisis dan laporan kehadiran siswa</p>
                    </div>

                    <!-- Filter Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="reportClass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Semua Kelas</option>
                                    <option value="X-1">Kelas X-1</option>
                                    <option value="X-2">Kelas X-2</option>
                                    <option value="X-3">Kelas X-3</option>
                                    <option value="X-4">Kelas X-4</option>
                                    <option value="X-5">Kelas X-5</option>
                                    <option value="X-6">Kelas X-6</option>
                                    <option value="X-7">Kelas X-7</option>
                                    <option value="X-8">Kelas X-8</option>
                                    <option value="X-9">Kelas X-9</option>
                                    <option value="X-10">Kelas X-10</option>
                                    <option value="X-11">Kelas X-11</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                                <input type="date" id="reportStartDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                                <input type="date" id="reportEndDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex items-end">
                                <button id="generateReport" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-all mobile-button">
                                    <i class="fas fa-search mr-2"></i>Generate
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Buttons -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button id="exportPDF" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="exportExcel" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button id="printReport" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                            <i class="fas fa-print mr-2"></i>Print
                        </button>
                    </div>

                    <!-- Report Results -->
                    <div id="reportResults" class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6 border-b border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900">Hasil Rekap</h3>
                        </div>
                        <div class="p-6">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar empty-state-icon"></i>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Laporan</h4>
                                <p class="text-gray-500">Pilih filter dan klik Generate untuk melihat rekap presensi siswa.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journal View -->
            <div id="journalView" class="view-content hidden">
                <div class="p-4 lg:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                        <div class="mb-4 sm:mb-0">
                            <h2 class="text-2xl font-bold text-gray-900">Rekap Jurnal</h2>
                            <p class="text-gray-600">Catat dan kelola jurnal pembelajaran harian</p>
                        </div>
                        <button id="addJournalBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-all mobile-button">
                            <i class="fas fa-plus mr-2"></i>Tambah Jurnal
                        </button>
                    </div>

                    <!-- Journal Form -->
                    <div id="journalForm" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tambah Jurnal Baru</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="journalDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="journalClass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X-1">Kelas X-1</option>
                                    <option value="X-2">Kelas X-2</option>
                                    <option value="X-3">Kelas X-3</option>
                                    <option value="X-4">Kelas X-4</option>
                                    <option value="X-5">Kelas X-5</option>
                                    <option value="X-6">Kelas X-6</option>
                                    <option value="X-7">Kelas X-7</option>
                                    <option value="X-8">Kelas X-8</option>
                                    <option value="X-9">Kelas X-9</option>
                                    <option value="X-10">Kelas X-10</option>
                                    <option value="X-11">Kelas X-11</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input type="text" id="journalSubject" placeholder="Contoh: Matematika" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Pembelajaran</label>
                            <textarea id="journalActivity" rows="4" placeholder="Deskripsikan kegiatan pembelajaran yang dilakukan..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan</label>
                            <textarea id="journalNotes" rows="3" placeholder="Catatan khusus, kendala, atau hal penting lainnya..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button id="saveJournal" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-save mr-2"></i>Simpan Jurnal
                            </button>
                            <button id="cancelJournal" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-all mobile-button">
                                <i class="fas fa-times mr-2"></i>Batal
                            </button>
                        </div>
                    </div>

                    <!-- Journal List -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6 border-b border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900">Riwayat Jurnal</h3>
                        </div>
                        <div id="journalList" class="divide-y divide-gray-100">
                            <div class="p-6">
                                <div class="empty-state">
                                    <i class="fas fa-book empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Jurnal</h4>
                                    <p class="text-gray-500 mb-4">Mulai dengan menambahkan jurnal pembelajaran pertama Anda.</p>
                                    <button onclick="document.getElementById('addJournalBtn').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Tambah Jurnal Pertama
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav lg:hidden">
        <div class="flex items-center justify-around py-2">
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-blue-600" data-view="dashboard">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs font-medium">Dashboard</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="students">
                <i class="fas fa-users text-xl mb-1"></i>
                <span class="text-xs font-medium">Siswa</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="attendance">
                <i class="fas fa-check-circle text-xl mb-1"></i>
                <span class="text-xs font-medium">Presensi</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="reports">
                <i class="fas fa-chart-bar text-xl mb-1"></i>
                <span class="text-xs font-medium">Rekap</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="journal">
                <i class="fas fa-book text-xl mb-1"></i>
                <span class="text-xs font-medium">Jurnal</span>
            </button>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="spinner"></div>
                <span class="text-gray-700">Memproses...</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="studentModalTitle" class="text-lg font-semibold text-gray-900">Tambah Siswa Baru</h3>
                    <button id="closeStudentModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="studentForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIS *</label>
                        <input type="text" id="studentNIS" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 2024010001">
                        <button type="button" id="generateNIS" class="mt-1 text-sm text-blue-600 hover:text-blue-800">Generate NIS Otomatis</button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="studentName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Sutrisno">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                        <select id="studentClass" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="X-1">Kelas X-1</option>
                            <option value="X-2">Kelas X-2</option>
                            <option value="X-3">Kelas X-3</option>
                            <option value="X-4">Kelas X-4</option>
                            <option value="X-5">Kelas X-5</option>
                            <option value="X-6">Kelas X-6</option>
                            <option value="X-7">Kelas X-7</option>
                            <option value="X-8">Kelas X-8</option>
                            <option value="X-9">Kelas X-9</option>
                            <option value="X-10">Kelas X-10</option>
                            <option value="X-11">Kelas X-11</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Kelamin *</label>
                        <select id="studentGender" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                        <input type="tel" id="studentPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 081234567890">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                        <textarea id="studentAddress" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Alamat lengkap siswa"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Orang Tua</label>
                        <input type="text" id="studentParentName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama orang tua/wali">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon Orang Tua</label>
                        <input type="tel" id="studentParentPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="No. telepon orang tua">
                    </div>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 flex space-x-3">
                <button id="cancelStudent" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-all">
                    Batal
                </button>
                <button id="saveStudent" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-all">
                    Simpan Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Hapus Siswa</h3>
                <p class="text-gray-600 text-center mb-6">Apakah Anda yakin ingin menghapus siswa ini? Data yang sudah dihapus tidak dapat dikembalikan.</p>
                <div class="flex space-x-3">
                    <button id="cancelDelete" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-all">
                        Batal
                    </button>
                    <button id="confirmDelete" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium transition-all">
                        Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Students Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Import Data Siswa</h3>
                    <button id="closeImportModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Upload file Excel (.xlsx) dengan format yang sesuai. 
                        <a href="#" id="downloadTemplateLink" class="text-blue-600 hover:text-blue-800">Download template</a> 
                        jika belum punya.
                    </p>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                        <div id="dropZone" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Klik untuk pilih file atau drag & drop</p>
                            <p class="text-sm text-gray-500 mt-1">Format: Excel (.xlsx, .xls)</p>
                        </div>
                        <div id="fileInfo" class="hidden">
                            <i class="fas fa-file-excel text-green-500 text-2xl mb-2"></i>
                            <p id="fileName" class="text-sm font-medium text-gray-900"></p>
                            <p id="fileSize" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="font-medium text-gray-900 mb-2">Format Excel yang diperlukan:</h4>
                    <div class="bg-gray-50 p-3 rounded-lg text-sm">
                        <div class="grid grid-cols-4 gap-2 font-medium text-gray-700 mb-1">
                            <span>NIS</span>
                            <span>Nama</span>
                            <span>Kelas</span>
                            <span>Gender</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-gray-600">
                            <span>202401001</span>
                            <span>Ahmad Budi</span>
                            <span>X-1</span>
                            <span>L</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex space-x-3">
                <button id="cancelImport" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-all">
                    Batal
                </button>
                <button id="processImport" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Import Data
                </button>
            </div>
        </div>
    </div>

    <!-- Teacher Profile Modal -->
    <div id="teacherProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Pengaturan Profil Guru</h3>
                    <button id="closeTeacherModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="teacherProfileForm" class="p-6">
                <div class="space-y-4">
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center overflow-hidden mb-4" id="profilePhotoPreview">
                            <i class="fas fa-user text-white text-2xl" id="profileIcon"></i>
                            <img id="profilePhotoImg" class="w-full h-full object-cover hidden" alt="Foto Profil">
                        </div>
                        <input type="file" id="photoInput" accept="image/*" class="hidden">
                        <button type="button" id="changePhotoBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                            <i class="fas fa-camera mr-2"></i>Ubah Foto
                        </button>
                        <button type="button" id="removePhotoBtn" class="text-red-600 hover:text-red-800 text-sm mt-2 hidden">
                            <i class="fas fa-trash mr-1"></i>Hapus Foto
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="teacherNameInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Sentosa Selalu, S.Pd">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran *</label>
                        <input type="text" id="teacherSubjectInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Matematika">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                        <input type="text" id="teacherNIP" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nomor Induk Pegawai">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="teacherEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="email@sekolah.sch.id">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                        <input type="tel" id="teacherPhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="081234567890">
                    </div>
                </div>
            </form>
            <div class="p-6 border-t border-gray-200 flex space-x-3">
                <button id="cancelTeacherProfile" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-medium transition-all">
                    Batal
                </button>
                <button id="saveTeacherProfile" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-all">
                    Simpan Profil
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Berhasil!</span>
        </div>
    </div>

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Setup Basic Event Listeners -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.getAttribute('href').substring(1);
                    if (window.app && window.app.showView) window.app.showView(view);
                });
            });
            
            document.querySelectorAll('.nav-mobile-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.getAttribute('data-view');
                    if (window.app && window.app.showView) window.app.showView(view);
                });
            });
            
            // Quick Actions
            const quickButtons = document.querySelectorAll('.quick-action-btn');
            const quickViews = ['attendance', 'reports', 'students', 'journal'];
            quickButtons.forEach((btn, i) => {
                btn.addEventListener('click', () => {
                    if (window.app && window.app.showView) window.app.showView(quickViews[i]);
                });
            });
            
            // Profil Guru
            const profileTriggers = [document.getElementById('teacherProfile'), document.getElementById('profileBtn')];
            profileTriggers.forEach(el => {
                if (el) el.addEventListener('click', () => {
                    if (window.app && window.app.showTeacherProfileModal) window.app.showTeacherProfileModal();
                });
            });
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            ['attendanceDate', 'journalDate', 'reportStartDate', 'reportEndDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = today;
            });

            // Close error toast
            const closeErrorToast = document.getElementById('closeErrorToast');
            if (closeErrorToast) {
                closeErrorToast.addEventListener('click', () => {
                    const errorToast = document.getElementById('errorToast');
                    if (errorToast) {
                        errorToast.classList.remove('show');
                    }
                });
            }
        });
    </script>

    <!-- Load app-complete.js LAST -->
    <script>
        // Error handling utility functions
        window.errorHandler = {
            showError: function(message, details = null) {
                console.error('Application Error:', message, details);
                
                const errorToast = document.getElementById('errorToast');
                const errorMessage = document.getElementById('errorMessage');
                
                if (errorToast && errorMessage) {
                    errorMessage.textContent = message;
                    errorToast.classList.add('show');
                    
                    // Auto hide after 5 seconds
                    setTimeout(() => {
                        errorToast.classList.remove('show');
                    }, 5000);
                }
                
                // Fallback to regular toast if error toast fails
                if (window.app && window.app.showToast) {
                    window.app.showToast(message, 'error');
                }
            },
            
            handleSupabaseError: function(error, operation) {
                let message = `Terjadi kesalahan saat ${operation}`;
                
                if (error && error.message) {
                    // Handle specific Supabase error codes
                    if (error.code === 'PGRST116') {
                        message = 'Data tidak ditemukan';
                    } else if (error.code === '23505') {
                        message = 'Data sudah ada, tidak dapat duplikasi';
                    } else if (error.code === '23503') {
                        message = 'Data referensi tidak valid';
                    } else if (error.code === '42501') {
                        message = 'Anda tidak memiliki izin untuk melakukan operasi ini';
                    } else if (error.code === '08006') {
                        message = 'Koneksi ke database gagal, periksa koneksi internet Anda';
                    } else {
                        message = `${message}: ${error.message}`;
                    }
                }
                
                this.showError(message, error);
                return { success: false, error: message };
            },
            
            safeAsyncOperation: async function(operation, operationName, fallbackValue = null) {
                try {
                    return await operation();
                } catch (error) {
                    this.handleSupabaseError(error, operationName);
                    return fallbackValue;
                }
            }
        };

        // Initialize Supabase with error handling
        window.initializeSupabase = function() {
            try {
                const supabaseUrl = 'https://your-project.supabase.co';
                const supabaseKey = 'your-supabase-key';
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabase URL or key is missing');
                }
                
                return window.supabase.createClient(supabaseUrl, supabaseKey);
            } catch (error) {
                window.errorHandler.handleSupabaseError(error, 'menginisialisasi Supabase');
                return null;
            }
        };
    </script>

    <script>
        // Main Application with improved error handling
        window.app = {
            // State management
            state: {
                currentView: 'dashboard',
                students: [],
                attendance: [],
                journals: [],
                teacherProfile: null,
                isOnline: navigator.onLine,
                isLoading: false
            },
            
            // Initialize app
            init: async function() {
                try {
                    // Initialize Supabase
                    this.supabase = window.initializeSupabase();
                    if (!this.supabase) {
                        throw new Error('Failed to initialize Supabase');
                    }
                    
                    // Set up connection status monitoring
                    this.setupConnectionStatus();
                    
                    // Load initial data
                    await Promise.all([
                        this.loadTeacherProfile(),
                        this.loadStudents(),
                        this.loadDashboardData()
                    ]);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Hide splash screen
                    setTimeout(() => {
                        const splashScreen = document.getElementById('splashScreen');
                        if (splashScreen) {
                            splashScreen.style.opacity = '0';
                            splashScreen.style.transition = 'opacity 0.5s';
                            setTimeout(() => {
                                splashScreen.style.display = 'none';
                            }, 500);
                        }
                    }, 1500);
                    
                    // Update current date
                    this.updateCurrentDate();
                    
                    // Initialize charts
                    this.initializeCharts();
                    
                    console.log('Application initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize application:', error);
                    window.errorHandler.handleSupabaseError(error, 'menginisialisasi aplikasi');
                    
                    // Hide splash screen even if initialization fails
                    const splashScreen = document.getElementById('splashScreen');
                    if (splashScreen) {
                        splashScreen.style.display = 'none';
                    }
                }
            },
            
            // Load teacher profile with improved error handling
            loadTeacherProfile: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    const { data, error } = await this.supabase
                        .from('teacher_profiles')
                        .select('*')
                        .single();
                    
                    if (error) throw error;
                    
                    this.state.teacherProfile = data;
                    this.updateTeacherProfileUI(data);
                    
                    return data;
                }, 'memuat profil guru', {});
            },
            
            // Update teacher profile UI
            updateTeacherProfileUI: function(profile) {
                try {
                    // Update desktop profile
                    const teacherName = document.getElementById('teacherName');
                    const teacherSubject = document.getElementById('teacherSubject');
                    const teacherIcon = document.getElementById('teacherIcon');
                    const teacherPhoto = document.getElementById('teacherPhoto');
                    
                    if (teacherName) teacherName.textContent = profile.name || 'Guru';
                    if (teacherSubject) teacherSubject.textContent = profile.subject || 'Mata Pelajaran';
                    
                    if (profile.photo_url) {
                        if (teacherPhoto) {
                            teacherPhoto.src = profile.photo_url;
                            teacherPhoto.classList.remove('hidden');
                        }
                        if (teacherIcon) teacherIcon.classList.add('hidden');
                    }
                    
                    // Update mobile profile
                    const mobileTeacherIcon = document.getElementById('mobileTeacherIcon');
                    const mobileTeacherPhoto = document.getElementById('mobileTeacherPhoto');
                    
                    if (profile.photo_url) {
                        if (mobileTeacherPhoto) {
                            mobileTeacherPhoto.src = profile.photo_url;
                            mobileTeacherPhoto.classList.remove('hidden');
                        }
                        if (mobileTeacherIcon) mobileTeacherIcon.classList.add('hidden');
                    }
                    
                    // Update form inputs
                    const teacherNameInput = document.getElementById('teacherNameInput');
                    const teacherSubjectInput = document.getElementById('teacherSubjectInput');
                    const teacherNIP = document.getElementById('teacherNIP');
                    const teacherEmail = document.getElementById('teacherEmail');
                    const teacherPhone = document.getElementById('teacherPhone');
                    
                    if (teacherNameInput) teacherNameInput.value = profile.name || '';
                    if (teacherSubjectInput) teacherSubjectInput.value = profile.subject || '';
                    if (teacherNIP) teacherNIP.value = profile.nip || '';
                    if (teacherEmail) teacherEmail.value = profile.email || '';
                    if (teacherPhone) teacherPhone.value = profile.phone || '';
                    
                    // Update profile photo preview
                    const profilePhotoImg = document.getElementById('profilePhotoImg');
                    const profileIcon = document.getElementById('profileIcon');
                    const removePhotoBtn = document.getElementById('removePhotoBtn');
                    
                    if (profile.photo_url) {
                        if (profilePhotoImg) {
                            profilePhotoImg.src = profile.photo_url;
                            profilePhotoImg.classList.remove('hidden');
                        }
                        if (profileIcon) profileIcon.classList.add('hidden');
                        if (removePhotoBtn) removePhotoBtn.classList.remove('hidden');
                    } else {
                        if (profilePhotoImg) profilePhotoImg.classList.add('hidden');
                        if (profileIcon) profileIcon.classList.remove('hidden');
                        if (removePhotoBtn) removePhotoBtn.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error updating teacher profile UI:', error);
                }
            },
            
            // Load students with improved error handling
            loadStudents: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    const { data, error } = await this.supabase
                        .from('students')
                        .select('*')
                        .order('name');
                    
                    if (error) throw error;
                    
                    this.state.students = data || [];
                    this.updateStudentsTable();
                    
                    return data;
                }, 'memuat data siswa', []);
            },
            
            // Update students table
            updateStudentsTable: function() {
                try {
                    const studentsTableBody = document.getElementById('studentsTableBody');
                    if (!studentsTableBody) return;
                    
                    if (this.state.students.length === 0) {
                        studentsTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="p-8">
                                    <div class="empty-state">
                                        <i class="fas fa-users empty-state-icon"></i>
                                        <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Data Siswa</h4>
                                        <p class="text-gray-500">Tambahkan siswa untuk memulai menggunakan aplikasi.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const classFilter = document.getElementById('classFilter')?.value || '';
                    const searchStudent = document.getElementById('searchStudent')?.value.toLowerCase() || '';
                    
                    let filteredStudents = this.state.students;
                    
                    if (classFilter) {
                        filteredStudents = filteredStudents.filter(student => student.class === classFilter);
                    }
                    
                    if (searchStudent) {
                        filteredStudents = filteredStudents.filter(student => 
                            student.name.toLowerCase().includes(searchStudent) || 
                            student.nis.toLowerCase().includes(searchStudent)
                        );
                    }
                    
                    studentsTableBody.innerHTML = filteredStudents.map(student => {
                        const attendance = this.calculateAttendancePercentage(student.id);
                        return `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-4">${student.nis}</td>
                                <td class="p-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-blue-600 text-sm"></i>
                                        </div>
                                        <span>${student.name}</span>
                                    </div>
                                </td>
                                <td class="p-4">${student.class}</td>
                                <td class="p-4">
                                    <div class="flex items-center">
                                        <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: ${attendance.present}%"></div>
                                        </div>
                                        <span class="text-sm text-gray-600">${attendance.present}%</span>
                                    </div>
                                </td>
                                <td class="p-4">
                                    <div class="flex space-x-2">
                                        <button class="edit-student-btn text-blue-600 hover:text-blue-800" data-id="${student.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-student-btn text-red-600 hover:text-red-800" data-id="${student.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.edit-student-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const studentId = btn.getAttribute('data-id');
                            this.editStudent(studentId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-student-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const studentId = btn.getAttribute('data-id');
                            this.confirmDeleteStudent(studentId);
                        });
                    });
                } catch (error) {
                    console.error('Error updating students table:', error);
                    window.errorHandler.showError('Gagal memperbarui tabel siswa');
                }
            },
            
            // Calculate attendance percentage
            calculateAttendancePercentage: function(studentId) {
                try {
                    const studentAttendance = this.state.attendance.filter(
                        record => record.student_id === studentId
                    );
                    
                    if (studentAttendance.length === 0) {
                        return { present: 0, absent: 0, excused: 0 };
                    }
                    
                    const present = studentAttendance.filter(
                        record => record.status === 'present'
                    ).length;
                    
                    const absent = studentAttendance.filter(
                        record => record.status === 'absent'
                    ).length;
                    
                    const excused = studentAttendance.filter(
                        record => record.status === 'excused'
                    ).length;
                    
                    const total = studentAttendance.length;
                    
                    return {
                        present: Math.round((present / total) * 100),
                        absent: Math.round((absent / total) * 100),
                        excused: Math.round((excused / total) * 100)
                    };
                } catch (error) {
                    console.error('Error calculating attendance percentage:', error);
                    return { present: 0, absent: 0, excused: 0 };
                }
            },
            
            // Load dashboard data with improved error handling
            loadDashboardData: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    // Get today's date in YYYY-MM-DD format
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Load attendance data
                    const { data: attendanceData, error: attendanceError } = await this.supabase
                        .from('attendance')
                        .select('*')
                        .eq('date', today);
                    
                    if (attendanceError) throw attendanceError;
                    
                    this.state.attendance = attendanceData || [];
                    
                    // Update dashboard stats
                    this.updateDashboardStats();
                    
                    // Update recent activity
                    this.updateRecentActivity();
                    
                    // Update charts
                    this.updateCharts();
                    
                    return attendanceData;
                }, 'memuat data dashboard', []);
            },
            
            // Update dashboard stats
            updateDashboardStats: function() {
                try {
                    const totalStudents = this.state.students.length;
                    const today = new Date().toISOString().split('T')[0];
                    
                    const todayAttendance = this.state.attendance.filter(
                        record => record.date === today
                    );
                    
                    const presentToday = todayAttendance.filter(
                        record => record.status === 'present'
                    ).length;
                    
                    const absentToday = todayAttendance.filter(
                        record => record.status === 'absent'
                    ).length;
                    
                    const excusedToday = todayAttendance.filter(
                        record => record.status === 'excused'
                    ).length;
                    
                    // Update UI
                    const totalStudentsEl = document.getElementById('totalStudents');
                    const presentTodayEl = document.getElementById('presentToday');
                    const absentTodayEl = document.getElementById('absentToday');
                    const excusedTodayEl = document.getElementById('excusedToday');
                    
                    if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
                    if (presentTodayEl) presentTodayEl.textContent = presentToday;
                    if (absentTodayEl) absentTodayEl.textContent = absentToday;
                    if (excusedTodayEl) excusedTodayEl.textContent = excusedToday;
                } catch (error) {
                    console.error('Error updating dashboard stats:', error);
                }
            },
            
            // Update recent activity
            updateRecentActivity: function() {
                try {
                    const recentActivityEl = document.getElementById('recentActivity');
                    if (!recentActivityEl) return;
                    
                    // Combine attendance and journal activities
                    const activities = [];
                    
                    // Add attendance activities
                    this.state.attendance.slice(-5).forEach(record => {
                        const student = this.state.students.find(s => s.id === record.student_id);
                        if (student) {
                            activities.push({
                                type: 'attendance',
                                date: record.date,
                                studentName: student.name,
                                status: record.status,
                                subject: record.subject
                            });
                        }
                    });
                    
                    // Add journal activities
                    this.state.journals.slice(-5).forEach(journal => {
                        activities.push({
                            type: 'journal',
                            date: journal.date,
                            subject: journal.subject,
                            class: journal.class
                        });
                    });
                    
                    // Sort by date (newest first)
                    activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Take the 5 most recent activities
                    const recentActivities = activities.slice(0, 5);
                    
                    if (recentActivities.length === 0) {
                        recentActivityEl.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-clock empty-state-icon"></i>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Aktivitas</h4>
                                <p class="text-gray-500">Aktivitas terbaru akan muncul di sini setelah Anda mulai menggunakan aplikasi.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    recentActivityEl.innerHTML = recentActivities.map(activity => {
                        if (activity.type === 'attendance') {
                            const statusClass = {
                                'present': 'text-green-600',
                                'absent': 'text-red-600',
                                'excused': 'text-yellow-600'
                            }[activity.status] || 'text-gray-600';
                            
                            const statusText = {
                                'present': 'Hadir',
                                'absent': 'Tidak Hadir',
                                'excused': 'Izin/Sakit'
                            }[activity.status] || 'Unknown';
                            
                            return `
                                <div class="flex items-start">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 mt-1">
                                        <i class="fas fa-check-circle text-blue-600 text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">Presensi: ${activity.studentName}</p>
                                        <p class="text-sm text-gray-600">${activity.subject} - <span class="${statusClass}">${statusText}</span></p>
                                        <p class="text-xs text-gray-500">${this.formatDate(activity.date)}</p>
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="flex items-start">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-3 mt-1">
                                        <i class="fas fa-book text-purple-600 text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">Jurnal: ${activity.subject}</p>
                                        <p class="text-sm text-gray-600">Kelas ${activity.class}</p>
                                        <p class="text-xs text-gray-500">${this.formatDate(activity.date)}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                } catch (error) {
                    console.error('Error updating recent activity:', error);
                }
            },
            
            // Format date
            formatDate: function(dateString) {
                try {
                    const date = new Date(dateString);
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    return date.toLocaleDateString('id-ID', options);
                } catch (error) {
                    console.error('Error formatting date:', error);
                    return dateString;
                }
            },
            
            // Initialize charts
            initializeCharts: function() {
                try {
                    // Attendance Chart
                    const attendanceChartCtx = document.getElementById('attendanceChart');
                    if (attendanceChartCtx) {
                        this.attendanceChart = new Chart(attendanceChartCtx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Hadir',
                                    data: [],
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.3
                                }, {
                                    label: 'Tidak Hadir',
                                    data: [],
                                    borderColor: 'rgb(239, 68, 68)',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.3
                                }, {
                                    label: 'Izin/Sakit',
                                    data: [],
                                    borderColor: 'rgb(245, 158, 11)',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                    
                    // Class Performance Chart
                    const classChartCtx = document.getElementById('classChart');
                    if (classChartCtx) {
                        this.classChart = new Chart(classChartCtx, {
                            type: 'bar',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Kehadiran (%)',
                                    data: [],
                                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            },
            
            // Update charts
            updateCharts: function() {
                try {
                    // Get the last 7 days
                    const dates = [];
                    const today = new Date();
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        dates.push(date.toISOString().split('T')[0]);
                    }
                    
                    // Format dates for display
                    const dateLabels = dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                    });
                    
                    // Calculate attendance data for each day
                    const presentData = [];
                    const absentData = [];
                    const excusedData = [];
                    
                    dates.forEach(date => {
                        const dayAttendance = this.state.attendance.filter(
                            record => record.date === date
                        );
                        
                        const present = dayAttendance.filter(
                            record => record.status === 'present'
                        ).length;
                        
                        const absent = dayAttendance.filter(
                            record => record.status === 'absent'
                        ).length;
                        
                        const excused = dayAttendance.filter(
                            record => record.status === 'excused'
                        ).length;
                        
                        presentData.push(present);
                        absentData.push(absent);
                        excusedData.push(excused);
                    });
                    
                    // Update attendance chart
                    if (this.attendanceChart) {
                        this.attendanceChart.data.labels = dateLabels;
                        this.attendanceChart.data.datasets[0].data = presentData;
                        this.attendanceChart.data.datasets[1].data = absentData;
                        this.attendanceChart.data.datasets[2].data = excusedData;
                        this.attendanceChart.update();
                    }
                    
                    // Calculate class performance
                    const classes = [...new Set(this.state.students.map(student => student.class))];
                    const classPerformance = [];
                    
                    classes.forEach(className => {
                        const classStudents = this.state.students.filter(
                            student => student.class === className
                        );
                        
                        if (classStudents.length === 0) {
                            classPerformance.push(0);
                            return;
                        }
                        
                        const classAttendance = this.state.attendance.filter(
                            record => classStudents.some(student => student.id === record.student_id)
                        );
                        
                        const present = classAttendance.filter(
                            record => record.status === 'present'
                        ).length;
                        
                        const percentage = classAttendance.length > 0 
                            ? Math.round((present / classAttendance.length) * 100)
                            : 0;
                        
                        classPerformance.push(percentage);
                    });
                    
                    // Update class performance chart
                    if (this.classChart) {
                        this.classChart.data.labels = classes;
                        this.classChart.data.datasets[0].data = classPerformance;
                        this.classChart.update();
                    }
                } catch (error) {
                    console.error('Error updating charts:', error);
                }
            },
            
            // Update current date
            updateCurrentDate: function() {
                try {
                    const currentDateEl = document.getElementById('currentDate');
                    if (currentDateEl) {
                        const options = { day: 'numeric', month: 'long', year: 'numeric' };
                        const today = new Date().toLocaleDateString('id-ID', options);
                        currentDateEl.textContent = today;
                    }
                } catch (error) {
                    console.error('Error updating current date:', error);
                }
            },
            
            // Setup connection status monitoring
            setupConnectionStatus: function() {
                try {
                    const updateConnectionStatus = () => {
                        const connectionStatus = document.getElementById('connectionStatus');
                        if (!connectionStatus) return;
                        
                        this.state.isOnline = navigator.onLine;
                        
                        if (this.state.isOnline) {
                            connectionStatus.className = 'connection-status online';
                            connectionStatus.innerHTML = '<i class="fas fa-wifi mr-1"></i><span>Online</span>';
                        } else {
                            connectionStatus.className = 'connection-status offline';
                            connectionStatus.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i><span>Offline</span>';
                        }
                    };
                    
                    // Initial update
                    updateConnectionStatus();
                    
                    // Listen for online/offline events
                    window.addEventListener('online', updateConnectionStatus);
                    window.addEventListener('offline', updateConnectionStatus);
                } catch (error) {
                    console.error('Error setting up connection status:', error);
                }
            },
            
            // Setup event listeners
            setupEventListeners: function() {
                try {
                    // Student management
                    const addStudentBtn = document.getElementById('addStudentBtn');
                    if (addStudentBtn) {
                        addStudentBtn.addEventListener('click', () => this.showAddStudentModal());
                    }
                    
                    const saveStudentBtn = document.getElementById('saveStudent');
                    if (saveStudentBtn) {
                        saveStudentBtn.addEventListener('click', () => this.saveStudent());
                    }
                    
                    const cancelStudentBtn = document.getElementById('cancelStudent');
                    const closeStudentModalBtn = document.getElementById('closeStudentModal');
                    [cancelStudentBtn, closeStudentModalBtn].forEach(btn => {
                        if (btn) {
                            btn.addEventListener('click', () => this.hideStudentModal());
                        }
                    });
                    
                    const generateNISBtn = document.getElementById('generateNIS');
                    if (generateNISBtn) {
                        generateNISBtn.addEventListener('click', () => this.generateNIS());
                    }
                    
                    // Import/Export students
                    const importStudentsBtn = document.getElementById('importStudentsBtn');
                    if (importStudentsBtn) {
                        importStudentsBtn.addEventListener('click', () => this.showImportModal());
                    }
                    
                    const exportStudentsBtn = document.getElementById('exportStudentsBtn');
                    if (exportStudentsBtn) {
                        exportStudentsBtn.addEventListener('click', () => this.exportStudents());
                    }
                    
                    const syncStudentsBtn = document.getElementById('syncStudentsBtn');
                    if (syncStudentsBtn) {
                        syncStudentsBtn.addEventListener('click', () => this.syncStudents());
                    }
                    
                    // Import modal
                    const cancelImportBtn = document.getElementById('cancelImport');
                    const closeImportModalBtn = document.getElementById('closeImportModal');
                    [cancelImportBtn, closeImportModalBtn].forEach(btn => {
                        if (btn) {
                            btn.addEventListener('click', () => this.hideImportModal());
                        }
                    });
                    
                    const processImportBtn = document.getElementById('processImport');
                    if (processImportBtn) {
                        processImportBtn.addEventListener('click', () => this.processImport());
                    }
                    
                    const dropZone = document.getElementById('dropZone');
                    const fileInput = document.getElementById('fileInput');
                    
                    if (dropZone && fileInput) {
                        dropZone.addEventListener('click', () => fileInput.click());
                        
                        dropZone.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            dropZone.classList.add('border-blue-400', 'bg-blue-50');
                        });
                        
                        dropZone.addEventListener('dragleave', () => {
                            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                        });
                        
                        dropZone.addEventListener('drop', (e) => {
                            e.preventDefault();
                            dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                            
                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                                this.handleFileSelect(files[0]);
                            }
                        });
                        
                        fileInput.addEventListener('change', (e) => {
                            if (e.target.files.length > 0) {
                                this.handleFileSelect(e.target.files[0]);
                            }
                        });
                    }
                    
                    // Attendance
                    const attendanceClass = document.getElementById('attendanceClass');
                    if (attendanceClass) {
                        attendanceClass.addEventListener('change', () => this.loadAttendanceStudents());
                    }
                    
                    const markAllPresentBtn = document.getElementById('markAllPresent');
                    if (markAllPresentBtn) {
                        markAllPresentBtn.addEventListener('click', () => this.markAllAttendance('present'));
                    }
                    
                    const markAllAbsentBtn = document.getElementById('markAllAbsent');
                    if (markAllAbsentBtn) {
                        markAllAbsentBtn.addEventListener('click', () => this.markAllAttendance('absent'));
                    }
                    
                    const copyYesterdayBtn = document.getElementById('copyYesterday');
                    if (copyYesterdayBtn) {
                        copyYesterdayBtn.addEventListener('click', () => this.copyYesterdayAttendance());
                    }
                    
                    const saveAttendanceBtn = document.getElementById('saveAttendance');
                    if (saveAttendanceBtn) {
                        saveAttendanceBtn.addEventListener('click', () => this.saveAttendance());
                    }
                    
                    // Reports
                    const generateReportBtn = document.getElementById('generateReport');
                    if (generateReportBtn) {
                        generateReportBtn.addEventListener('click', () => this.generateReport());
                    }
                    
                    const exportPDFBtn = document.getElementById('exportPDF');
                    if (exportPDFBtn) {
                        exportPDFBtn.addEventListener('click', () => this.exportReport('pdf'));
                    }
                    
                    const exportExcelBtn = document.getElementById('exportExcel');
                    if (exportExcelBtn) {
                        exportExcelBtn.addEventListener('click', () => this.exportReport('excel'));
                    }
                    
                    const printReportBtn = document.getElementById('printReport');
                    if (printReportBtn) {
                        printReportBtn.addEventListener('click', () => this.printReport());
                    }
                    
                    // Journal
                    const addJournalBtn = document.getElementById('addJournalBtn');
                    if (addJournalBtn) {
                        addJournalBtn.addEventListener('click', () => this.showJournalForm());
                    }
                    
                    const saveJournalBtn = document.getElementById('saveJournal');
                    if (saveJournalBtn) {
                        saveJournalBtn.addEventListener('click', () => this.saveJournal());
                    }
                    
                    const cancelJournalBtn = document.getElementById('cancelJournal');
                    if (cancelJournalBtn) {
                        cancelJournalBtn.addEventListener('click', () => this.hideJournalForm());
                    }
                    
                    // Teacher profile
                    const saveTeacherProfileBtn = document.getElementById('saveTeacherProfile');
                    if (saveTeacherProfileBtn) {
                        saveTeacherProfileBtn.addEventListener('click', () => this.saveTeacherProfile());
                    }
                    
                    const cancelTeacherProfileBtn = document.getElementById('cancelTeacherProfile');
                    const closeTeacherModalBtn = document.getElementById('closeTeacherModal');
                    [cancelTeacherProfileBtn, closeTeacherModalBtn].forEach(btn => {
                        if (btn) {
                            btn.addEventListener('click', () => this.hideTeacherProfileModal());
                        }
                    });
                    
                    const changePhotoBtn = document.getElementById('changePhotoBtn');
                    const photoInput = document.getElementById('photoInput');
                    
                    if (changePhotoBtn && photoInput) {
                        changePhotoBtn.addEventListener('click', () => photoInput.click());
                        
                        photoInput.addEventListener('change', (e) => {
                            if (e.target.files.length > 0) {
                                this.handleTeacherPhotoSelect(e.target.files[0]);
                            }
                        });
                    }
                    
                    const removePhotoBtn = document.getElementById('removePhotoBtn');
                    if (removePhotoBtn) {
                        removePhotoBtn.addEventListener('click', () => this.removeTeacherPhoto());
                    }
                    
                    // Delete confirmation
                    const cancelDeleteBtn = document.getElementById('cancelDelete');
                    if (cancelDeleteBtn) {
                        cancelDeleteBtn.addEventListener('click', () => this.hideDeleteModal());
                    }
                    
                    const confirmDeleteBtn = document.getElementById('confirmDelete');
                    if (confirmDeleteBtn) {
                        confirmDeleteBtn.addEventListener('click', () => this.deleteStudent());
                    }
                    
                    // Search and filter
                    const classFilter = document.getElementById('classFilter');
                    const searchStudent = document.getElementById('searchStudent');
                    
                    if (classFilter) {
                        classFilter.addEventListener('change', () => this.updateStudentsTable());
                    }
                    
                    if (searchStudent) {
                        searchStudent.addEventListener('input', () => this.updateStudentsTable());
                    }
                } catch (error) {
                    console.error('Error setting up event listeners:', error);
                }
            },
            
            // Show view
            showView: function(viewName) {
                try {
                    // Update navigation state
                    this.state.currentView = viewName;
                    
                    // Hide all views
                    document.querySelectorAll('.view-content').forEach(view => {
                        view.classList.add('hidden');
                    });
                    
                    // Show selected view
                    const selectedView = document.getElementById(`${viewName}View`);
                    if (selectedView) {
                        selectedView.classList.remove('hidden');
                    }
                    
                    // Update desktop navigation
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
                        item.classList.add('text-gray-600');
                        
                        if (item.getAttribute('href') === `#${viewName}`) {
                            item.classList.remove('text-gray-600');
                            item.classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
                        }
                    });
                    
                    // Update mobile navigation
                    document.querySelectorAll('.nav-mobile-btn').forEach(btn => {
                        btn.classList.remove('text-blue-600');
                        btn.classList.add('text-gray-400');
                        
                        if (btn.getAttribute('data-view') === viewName) {
                            btn.classList.remove('text-gray-400');
                            btn.classList.add('text-blue-600');
                        }
                    });
                    
                    // Load view-specific data
                    switch (viewName) {
                        case 'dashboard':
                            this.loadDashboardData();
                            break;
                        case 'students':
                            this.loadStudents();
                            break;
                        case 'attendance':
                            this.loadAttendanceData();
                            break;
                        case 'reports':
                            this.loadReportData();
                            break;
                        case 'journal':
                            this.loadJournalData();
                            break;
                    }
                } catch (error) {
                    console.error('Error showing view:', error);
                    window.errorHandler.showError('Gagal menampilkan halaman');
                }
            },
            
            // Show add student modal
            showAddStudentModal: function() {
                try {
                    const studentModal = document.getElementById('studentModal');
                    const studentModalTitle = document.getElementById('studentModalTitle');
                    const studentForm = document.getElementById('studentForm');
                    
                    if (studentModal && studentModalTitle && studentForm) {
                        studentModalTitle.textContent = 'Tambah Siswa Baru';
                        studentForm.reset();
                        studentModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error showing add student modal:', error);
                    window.errorHandler.showError('Gagal menampilkan form tambah siswa');
                }
            },
            
            // Hide student modal
            hideStudentModal: function() {
                try {
                    const studentModal = document.getElementById('studentModal');
                    if (studentModal) {
                        studentModal.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding student modal:', error);
                }
            },
            
            // Generate NIS
            generateNIS: function() {
                try {
                    const currentYear = new Date().getFullYear();
                    const studentNIS = document.getElementById('studentNIS');
                    
                    if (studentNIS) {
                        // Find the highest NIS for the current year
                        const yearPrefix = currentYear.toString();
                        const studentsWithYear = this.state.students.filter(
                            student => student.nis.startsWith(yearPrefix)
                        );
                        
                        let nextNumber = 1;
                        
                        if (studentsWithYear.length > 0) {
                            const highestNIS = Math.max(...studentsWithYear.map(
                                student => parseInt(student.nis.substring(4))
                            ));
                            nextNumber = highestNIS + 1;
                        }
                        
                        const newNIS = `${yearPrefix}${nextNumber.toString().padStart(4, '0')}`;
                        studentNIS.value = newNIS;
                    }
                } catch (error) {
                    console.error('Error generating NIS:', error);
                    window.errorHandler.showError('Gagal generate NIS otomatis');
                }
            },
            
            // Save student with improved error handling
            saveStudent: async function() {
                try {
                    const studentNIS = document.getElementById('studentNIS').value;
                    const studentName = document.getElementById('studentName').value;
                    const studentClass = document.getElementById('studentClass').value;
                    const studentGender = document.getElementById('studentGender').value;
                    const studentPhone = document.getElementById('studentPhone').value;
                    const studentAddress = document.getElementById('studentAddress').value;
                    const studentParentName = document.getElementById('studentParentName').value;
                    const studentParentPhone = document.getElementById('studentParentPhone').value;
                    
                    // Validate required fields
                    if (!studentNIS || !studentName || !studentClass || !studentGender) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Check if NIS already exists
                    const existingStudent = this.state.students.find(
                        student => student.nis === studentNIS
                    );
                    
                    if (existingStudent) {
                        window.errorHandler.showError('NIS sudah digunakan oleh siswa lain');
                        this.hideLoading();
                        return;
                    }
                    
                    // Save to Supabase
                    const { data, error } = await this.supabase
                        .from('students')
                        .insert([{
                            nis: studentNIS,
                            name: studentName,
                            class: studentClass,
                            gender: studentGender,
                            phone: studentPhone || null,
                            address: studentAddress || null,
                            parent_name: studentParentName || null,
                            parent_phone: studentParentPhone || null
                        }])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local state
                    if (data && data.length > 0) {
                        this.state.students.push(data[0]);
                        this.updateStudentsTable();
                        this.updateDashboardStats();
                    }
                    
                    // Hide modal and loading
                    this.hideStudentModal();
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Siswa berhasil ditambahkan');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan data siswa');
                }
            },
            
            // Edit student
            editStudent: function(studentId) {
                try {
                    const student = this.state.students.find(s => s.id === studentId);
                    if (!student) {
                        window.errorHandler.showError('Siswa tidak ditemukan');
                        return;
                    }
                    
                    const studentModal = document.getElementById('studentModal');
                    const studentModalTitle = document.getElementById('studentModalTitle');
                    const studentForm = document.getElementById('studentForm');
                    
                    if (studentModal && studentModalTitle && studentForm) {
                        studentModalTitle.textContent = 'Edit Siswa';
                        
                        // Populate form
                        document.getElementById('studentNIS').value = student.nis;
                        document.getElementById('studentName').value = student.name;
                        document.getElementById('studentClass').value = student.class;
                        document.getElementById('studentGender').value = student.gender;
                        document.getElementById('studentPhone').value = student.phone || '';
                        document.getElementById('studentAddress').value = student.address || '';
                        document.getElementById('studentParentName').value = student.parent_name || '';
                        document.getElementById('studentParentPhone').value = student.parent_phone || '';
                        
                        // Store student ID for update
                        studentForm.setAttribute('data-student-id', studentId);
                        
                        studentModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error editing student:', error);
                    window.errorHandler.showError('Gagal menampilkan form edit siswa');
                }
            },
            
            // Update student with improved error handling
            updateStudent: async function(studentId) {
                try {
                    const studentNIS = document.getElementById('studentNIS').value;
                    const studentName = document.getElementById('studentName').value;
                    const studentClass = document.getElementById('studentClass').value;
                    const studentGender = document.getElementById('studentGender').value;
                    const studentPhone = document.getElementById('studentPhone').value;
                    const studentAddress = document.getElementById('studentAddress').value;
                    const studentParentName = document.getElementById('studentParentName').value;
                    const studentParentPhone = document.getElementById('studentParentPhone').value;
                    
                    // Validate required fields
                    if (!studentNIS || !studentName || !studentClass || !studentGender) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Check if NIS already exists (excluding current student)
                    const existingStudent = this.state.students.find(
                        student => student.nis === studentNIS && student.id !== studentId
                    );
                    
                    if (existingStudent) {
                        window.errorHandler.showError('NIS sudah digunakan oleh siswa lain');
                        this.hideLoading();
                        return;
                    }
                    
                    // Update in Supabase
                    const { data, error } = await this.supabase
                        .from('students')
                        .update({
                            nis: studentNIS,
                            name: studentName,
                            class: studentClass,
                            gender: studentGender,
                            phone: studentPhone || null,
                            address: studentAddress || null,
                            parent_name: studentParentName || null,
                            parent_phone: studentParentPhone || null
                        })
                        .eq('id', studentId)
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local state
                    if (data && data.length > 0) {
                        const index = this.state.students.findIndex(s => s.id === studentId);
                        if (index !== -1) {
                            this.state.students[index] = data[0];
                            this.updateStudentsTable();
                        }
                    }
                    
                    // Hide modal and loading
                    this.hideStudentModal();
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Data siswa berhasil diperbarui');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'memperbarui data siswa');
                }
            },
            
            // Confirm delete student
            confirmDeleteStudent: function(studentId) {
                try {
                    const deleteModal = document.getElementById('deleteModal');
                    const confirmDeleteBtn = document.getElementById('confirmDelete');
                    
                    if (deleteModal && confirmDeleteBtn) {
                        // Store student ID for deletion
                        confirmDeleteBtn.setAttribute('data-student-id', studentId);
                        deleteModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error confirming delete student:', error);
                    window.errorHandler.showError('Gagal menampilkan konfirmasi hapus');
                }
            },
            
            // Hide delete modal
            hideDeleteModal: function() {
                try {
                    const deleteModal = document.getElementById('deleteModal');
                    if (deleteModal) {
                        deleteModal.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding delete modal:', error);
                }
            },
            
            // Delete student with improved error handling
            deleteStudent: async function() {
                try {
                    const confirmDeleteBtn = document.getElementById('confirmDelete');
                    const studentId = confirmDeleteBtn.getAttribute('data-student-id');
                    
                    if (!studentId) {
                        window.errorHandler.showError('ID siswa tidak valid');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Delete from Supabase
                    const { error } = await this.supabase
                        .from('students')
                        .delete()
                        .eq('id', studentId);
                    
                    if (error) throw error;
                    
                    // Update local state
                    this.state.students = this.state.students.filter(s => s.id !== studentId);
                    this.updateStudentsTable();
                    this.updateDashboardStats();
                    
                    // Hide modal and loading
                    this.hideDeleteModal();
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Siswa berhasil dihapus');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menghapus siswa');
                }
            },
            
            // Show import modal
            showImportModal: function() {
                try {
                    const importModal = document.getElementById('importModal');
                    const fileInfo = document.getElementById('fileInfo');
                    const dropZone = document.getElementById('dropZone');
                    const fileInput = document.getElementById('fileInput');
                    const processImportBtn = document.getElementById('processImport');
                    
                    if (importModal && fileInfo && dropZone && fileInput && processImportBtn) {
                        // Reset file input
                        fileInput.value = '';
                        fileInfo.classList.add('hidden');
                        dropZone.classList.remove('hidden');
                        processImportBtn.disabled = true;
                        
                        importModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error showing import modal:', error);
                    window.errorHandler.showError('Gagal menampilkan form import');
                }
            },
            
            // Hide import modal
            hideImportModal: function() {
                try {
                    const importModal = document.getElementById('importModal');
                    if (importModal) {
                        importModal.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding import modal:', error);
                }
            },
            
            // Handle file select
            handleFileSelect: function(file) {
                try {
                    const fileInfo = document.getElementById('fileInfo');
                    const dropZone = document.getElementById('dropZone');
                    const fileName = document.getElementById('fileName');
                    const fileSize = document.getElementById('fileSize');
                    const processImportBtn = document.getElementById('processImport');
                    
                    if (fileInfo && dropZone && fileName && fileSize && processImportBtn) {
                        // Check file type
                        if (!file.name.match(/\.(xlsx|xls)$/)) {
                            window.errorHandler.showError('Harap pilih file Excel (.xlsx, .xls)');
                            return;
                        }
                        
                        // Update UI
                        fileName.textContent = file.name;
                        fileSize.textContent = this.formatFileSize(file.size);
                        
                        dropZone.classList.add('hidden');
                        fileInfo.classList.remove('hidden');
                        processImportBtn.disabled = false;
                        
                        // Store file for processing
                        this.selectedFile = file;
                    }
                } catch (error) {
                    console.error('Error handling file select:', error);
                    window.errorHandler.showError('Gagal memproses file yang dipilih');
                }
            },
            
            // Format file size
            formatFileSize: function(bytes) {
                try {
                    if (bytes === 0) return '0 Bytes';
                    
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                } catch (error) {
                    console.error('Error formatting file size:', error);
                    return 'Unknown size';
                }
            },
            
            // Process import with improved error handling
            processImport: async function() {
                try {
                    if (!this.selectedFile) {
                        window.errorHandler.showError('Tidak ada file yang dipilih');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Read file
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (jsonData.length === 0) {
                                window.errorHandler.showError('File tidak mengandung data');
                                this.hideLoading();
                                return;
                            }
                            
                            // Validate data
                            const requiredFields = ['NIS', 'Nama', 'Kelas', 'Gender'];
                            const invalidRows = [];
                            
                            jsonData.forEach((row, index) => {
                                const missingFields = requiredFields.filter(
                                    field => !row[field]
                                );
                                
                                if (missingFields.length > 0) {
                                    invalidRows.push({
                                        row: index + 2, // +2 because Excel rows start at 1 and header is row 1
                                        fields: missingFields
                                    });
                                }
                            });
                            
                            if (invalidRows.length > 0) {
                                const errorDetails = invalidRows.map(
                                    item => `Baris ${item.row}: ${item.fields.join(', ')}`
                                ).join('<br>');
                                
                                window.errorHandler.showError(
                                    `Data tidak valid. ${invalidRows.length} baris memiliki field yang kosong:<br>${errorDetails}`
                                );
                                this.hideLoading();
                                return;
                            }
                            
                            // Check for duplicate NIS
                            const nisList = jsonData.map(row => row.NIS);
                            const duplicateNIS = nisList.filter(
                                (nis, index) => nisList.indexOf(nis) !== index
                            );
                            
                            if (duplicateNIS.length > 0) {
                                window.errorHandler.showError(
                                    `Terdapat NIS duplikat dalam file: ${[...new Set(duplicateNIS)].join(', ')}`
                                );
                                this.hideLoading();
                                return;
                            }
                            
                            // Check for existing NIS in database
                            const existingNIS = this.state.students.map(student => student.nis);
                            const conflictingNIS = nisList.filter(nis => existingNIS.includes(nis));
                            
                            if (conflictingNIS.length > 0) {
                                const confirmOverwrite = confirm(
                                    `Terdapat ${conflictingNIS.length} NIS yang sudah ada dalam database. Apakah Anda ingin menimpanya?`
                                );
                                
                                if (!confirmOverwrite) {
                                    this.hideLoading();
                                    return;
                                }
                            }
                            
                            // Process data
                            const studentsToInsert = [];
                            const studentsToUpdate = [];
                            
                            jsonData.forEach(row => {
                                const studentData = {
                                    nis: row.NIS.toString(),
                                    name: row.Nama,
                                    class: row.Kelas,
                                    gender: row.Gender,
                                    phone: row['No. Telepon'] || null,
                                    address: row.Alamat || null,
                                    parent_name: row['Nama Orang Tua'] || null,
                                    parent_phone: row['No. Telepon Orang Tua'] || null
                                };
                                
                                const existingStudent = this.state.students.find(
                                    student => student.nis === studentData.nis
                                );
                                
                                if (existingStudent) {
                                    studentsToUpdate.push({
                                        id: existingStudent.id,
                                        ...studentData
                                    });
                                } else {
                                    studentsToInsert.push(studentData);
                                }
                            });
                            
                            // Insert new students
                            if (studentsToInsert.length > 0) {
                                const { error: insertError } = await this.supabase
                                    .from('students')
                                    .insert(studentsToInsert);
                                
                                if (insertError) throw insertError;
                            }
                            
                            // Update existing students
                            if (studentsToUpdate.length > 0) {
                                const updatePromises = studentsToUpdate.map(student => {
                                    return this.supabase
                                        .from('students')
                                        .update({
                                            name: student.name,
                                            class: student.class,
                                            gender: student.gender,
                                            phone: student.phone,
                                            address: student.address,
                                            parent_name: student.parent_name,
                                            parent_phone: student.parent_phone
                                        })
                                        .eq('id', student.id);
                                });
                                
                                const updateResults = await Promise.all(updatePromises);
                                const updateErrors = updateResults.filter(result => result.error);
                                
                                if (updateErrors.length > 0) {
                                    throw new Error(`Failed to update ${updateErrors.length} students`);
                                }
                            }
                            
                            // Reload students data
                            await this.loadStudents();
                            
                            // Hide modal and loading
                            this.hideImportModal();
                            this.hideLoading();
                            
                            // Show success message
                            this.showToast(
                                `Berhasil mengimport ${studentsToInsert.length} siswa baru dan memperbarui ${studentsToUpdate.length} siswa`
                            );
                        } catch (error) {
                            this.hideLoading();
                            window.errorHandler.handleSupabaseError(error, 'memproses import data');
                        }
                    };
                    
                    reader.onerror = () => {
                        this.hideLoading();
                        window.errorHandler.showError('Gagal membaca file');
                    };
                    
                    reader.readAsArrayBuffer(this.selectedFile);
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'memproses import data');
                }
            },
            
            // Export students with improved error handling
            exportStudents: async function() {
                try {
                    // Show loading
                    this.showLoading();
                    
                    // Create workbook
                    const workbook = XLSX.utils.book_new();
                    
                    // Convert students data to worksheet
                    const worksheetData = this.state.students.map(student => ({
                        'NIS': student.nis,
                        'Nama': student.name,
                        'Kelas': student.class,
                        'Gender': student.gender,
                        'No. Telepon': student.phone || '',
                        'Alamat': student.address || '',
                        'Nama Orang Tua': student.parent_name || '',
                        'No. Telepon Orang Tua': student.parent_phone || ''
                    }));
                    
                    const worksheet = XLSX.utils.json_to_sheet(worksheetData);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Siswa');
                    
                    // Generate filename with current date
                    const today = new Date().toISOString().split('T')[0];
                    const filename = `Data_Siswa_${today}.xlsx`;
                    
                    // Save workbook
                    XLSX.writeFile(workbook, filename);
                    
                    // Hide loading
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Data siswa berhasil diekspor');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'mengekspor data siswa');
                }
            },
            
            // Sync students with improved error handling
            syncStudents: async function() {
                try {
                    // Show loading
                    this.showLoading();
                    
                    // Reload students data
                    await this.loadStudents();
                    
                    // Hide loading
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Data siswa berhasil disinkronisasi');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyinkronkan data siswa');
                }
            },
            
            // Load attendance data with improved error handling
            loadAttendanceData: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    const { data, error } = await this.supabase
                        .from('attendance')
                        .select('*');
                    
                    if (error) throw error;
                    
                    this.state.attendance = data || [];
                    return data;
                }, 'memuat data presensi', []);
            },
            
            // Load attendance students
            loadAttendanceStudents: async function() {
                try {
                    const attendanceClass = document.getElementById('attendanceClass').value;
                    const attendanceStudentsList = document.getElementById('attendanceStudentsList');
                    const saveAttendanceBtn = document.getElementById('saveAttendance');
                    
                    if (!attendanceClass) {
                        if (attendanceStudentsList) {
                            attendanceStudentsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-clipboard-list empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Pilih Kelas</h4>
                                    <p class="text-gray-500">Pilih kelas dari dropdown di atas untuk menampilkan daftar siswa dan mulai input presensi.</p>
                                </div>
                            `;
                        }
                        
                        if (saveAttendanceBtn) {
                            saveAttendanceBtn.disabled = true;
                        }
                        
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Get students for the selected class
                    const classStudents = this.state.students.filter(
                        student => student.class === attendanceClass
                    );
                    
                    if (classStudents.length === 0) {
                        if (attendanceStudentsList) {
                            attendanceStudentsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-users empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Siswa</h4>
                                    <p class="text-gray-500">Tidak ada siswa di kelas ini. Silakan tambahkan siswa terlebih dahulu.</p>
                                </div>
                            `;
                        }
                        
                        if (saveAttendanceBtn) {
                            saveAttendanceBtn.disabled = true;
                        }
                        
                        this.hideLoading();
                        return;
                    }
                    
                    // Get today's date
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    
                    // Get existing attendance records for today
                    const todayAttendance = this.state.attendance.filter(
                        record => record.date === attendanceDate && 
                                classStudents.some(student => student.id === record.student_id)
                    );
                    
                    // Create attendance list UI
                    let attendanceListHTML = '<div class="space-y-3">';
                    
                    classStudents.forEach(student => {
                        const existingRecord = todayAttendance.find(
                            record => record.student_id === student.id
                        );
                        
                        const status = existingRecord ? existingRecord.status : '';
                        
                        attendanceListHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${student.name}</p>
                                        <p class="text-sm text-gray-600">${student.nis}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm font-medium transition-all ${
                                        status === 'present' 
                                            ? 'bg-green-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-green-500 hover:text-white'
                                    }" data-student-id="${student.id}" data-status="present">
                                        Hadir
                                    </button>
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm font-medium transition-all ${
                                        status === 'absent' 
                                            ? 'bg-red-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white'
                                    }" data-student-id="${student.id}" data-status="absent">
                                        Tidak Hadir
                                    </button>
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm font-medium transition-all ${
                                        status === 'excused' 
                                            ? 'bg-yellow-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-yellow-500 hover:text-white'
                                    }" data-student-id="${student.id}" data-status="excused">
                                        Izin/Sakit
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    attendanceListHTML += '</div>';
                    
                    if (attendanceStudentsList) {
                        attendanceStudentsList.innerHTML = attendanceListHTML;
                    }
                    
                    if (saveAttendanceBtn) {
                        saveAttendanceBtn.disabled = false;
                    }
                    
                    // Add event listeners to attendance buttons
                    document.querySelectorAll('.attendance-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const studentId = btn.getAttribute('data-student-id');
                            const status = btn.getAttribute('data-status');
                            
                            // Update button states
                            document.querySelectorAll(`.attendance-btn[data-student-id="${studentId}"]`).forEach(b => {
                                b.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-white');
                                b.classList.add('bg-gray-200', 'text-gray-700');
                            });
                            
                            btn.classList.remove('bg-gray-200', 'text-gray-700');
                            
                            if (status === 'present') {
                                btn.classList.add('bg-green-500', 'text-white');
                            } else if (status === 'absent') {
                                btn.classList.add('bg-red-500', 'text-white');
                            } else if (status === 'excused') {
                                btn.classList.add('bg-yellow-500', 'text-white');
                            }
                        });
                    });
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'memuat daftar siswa untuk presensi');
                }
            },
            
            // Mark all attendance
            markAllAttendance: function(status) {
                try {
                    document.querySelectorAll('.attendance-btn').forEach(btn => {
                        if (btn.getAttribute('data-status') === status) {
                            btn.click();
                        }
                    });
                } catch (error) {
                    console.error('Error marking all attendance:', error);
                    window.errorHandler.showError('Gagal menandai semua siswa');
                }
            },
            
            // Copy yesterday attendance with improved error handling
            copyYesterdayAttendance: async function() {
                try {
                    const attendanceClass = document.getElementById('attendanceClass').value;
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    
                    if (!attendanceClass || !attendanceDate) {
                        window.errorHandler.showError('Harap pilih kelas dan tanggal');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Get yesterday's date
                    const yesterday = new Date(attendanceDate);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayString = yesterday.toISOString().split('T')[0];
                    
                    // Get students for the selected class
                    const classStudents = this.state.students.filter(
                        student => student.class === attendanceClass
                    );
                    
                    if (classStudents.length === 0) {
                        window.errorHandler.showError('Tidak ada siswa di kelas ini');
                        this.hideLoading();
                        return;
                    }
                    
                    // Get yesterday's attendance records
                    const yesterdayAttendance = this.state.attendance.filter(
                        record => record.date === yesterdayString && 
                                classStudents.some(student => student.id === record.student_id)
                    );
                    
                    if (yesterdayAttendance.length === 0) {
                        window.errorHandler.showError('Tidak ada data presensi untuk kemarin');
                        this.hideLoading();
                        return;
                    }
                    
                    // Apply yesterday's attendance to today
                    yesterdayAttendance.forEach(record => {
                        const btn = document.querySelector(
                            `.attendance-btn[data-student-id="${record.student_id}"][data-status="${record.status}"]`
                        );
                        
                        if (btn) {
                            btn.click();
                        }
                    });
                    
                    this.hideLoading();
                    this.showToast('Berhasil menyalin presensi dari kemarin');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyalin presensi kemarin');
                }
            },
            
            // Save attendance with improved error handling
            saveAttendance: async function() {
                try {
                    const attendanceClass = document.getElementById('attendanceClass').value;
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    const attendanceSubject = document.getElementById('attendanceSubject').value;
                    
                    if (!attendanceClass || !attendanceDate || !attendanceSubject) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Get students for the selected class
                    const classStudents = this.state.students.filter(
                        student => student.class === attendanceClass
                    );
                    
                    if (classStudents.length === 0) {
                        window.errorHandler.showError('Tidak ada siswa di kelas ini');
                        this.hideLoading();
                        return;
                    }
                    
                    // Collect attendance data
                    const attendanceData = [];
                    
                    classStudents.forEach(student => {
                        const activeBtn = document.querySelector(
                            `.attendance-btn[data-student-id="${student.id}"].bg-green-500, 
                             .attendance-btn[data-student-id="${student.id}"].bg-red-500, 
                             .attendance-btn[data-student-id="${student.id}"].bg-yellow-500`
                        );
                        
                        if (activeBtn) {
                            const status = activeBtn.getAttribute('data-status');
                            
                            attendanceData.push({
                                student_id: student.id,
                                date: attendanceDate,
                                subject: attendanceSubject,
                                status: status
                            });
                        }
                    });
                    
                    if (attendanceData.length === 0) {
                        window.errorHandler.showError('Tidak ada data presensi yang disimpan');
                        this.hideLoading();
                        return;
                    }
                    
                    // Get existing attendance records for today
                    const existingAttendance = this.state.attendance.filter(
                        record => record.date === attendanceDate && 
                                classStudents.some(student => student.id === record.student_id)
                    );
                    
                    // Delete existing records
                    if (existingAttendance.length > 0) {
                        const { error: deleteError } = await this.supabase
                            .from('attendance')
                            .delete()
                            .in('id', existingAttendance.map(record => record.id));
                        
                        if (deleteError) throw deleteError;
                    }
                    
                    // Insert new records
                    const { error: insertError } = await this.supabase
                        .from('attendance')
                        .insert(attendanceData);
                    
                    if (insertError) throw insertError;
                    
                    // Reload attendance data
                    await this.loadAttendanceData();
                    
                    // Update dashboard
                    this.updateDashboardStats();
                    this.updateRecentActivity();
                    this.updateCharts();
                    
                    // Hide loading
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Presensi berhasil disimpan');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan presensi');
                }
            },
            
            // Load report data with improved error handling
            loadReportData: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    // Load attendance data if not already loaded
                    if (this.state.attendance.length === 0) {
                        await this.loadAttendanceData();
                    }
                    
                    return this.state.attendance;
                }, 'memuat data laporan', []);
            },
            
            // Generate report with improved error handling
            generateReport: async function() {
                try {
                    const reportClass = document.getElementById('reportClass').value;
                    const reportStartDate = document.getElementById('reportStartDate').value;
                    const reportEndDate = document.getElementById('reportEndDate').value;
                    
                    if (!reportStartDate || !reportEndDate) {
                        window.errorHandler.showError('Harap pilih rentang tanggal');
                        return;
                    }
                    
                    if (new Date(reportStartDate) > new Date(reportEndDate)) {
                        window.errorHandler.showError('Tanggal awal tidak boleh lebih besar dari tanggal akhir');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Filter attendance data
                    let filteredAttendance = this.state.attendance.filter(
                        record => record.date >= reportStartDate && record.date <= reportEndDate
                    );
                    
                    // Filter by class if selected
                    if (reportClass) {
                        const classStudents = this.state.students.filter(
                            student => student.class === reportClass
                        );
                        
                        filteredAttendance = filteredAttendance.filter(
                            record => classStudents.some(student => student.id === record.student_id)
                        );
                    }
                    
                    if (filteredAttendance.length === 0) {
                        const reportResults = document.getElementById('reportResults');
                        if (reportResults) {
                            reportResults.innerHTML = `
                                <div class="p-6">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-bar empty-state-icon"></i>
                                        <h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Data</h4>
                                        <p class="text-gray-500">Tidak ada data presensi untuk rentang tanggal dan kelas yang dipilih.</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        this.hideLoading();
                        return;
                    }
                    
                    // Group by student
                    const reportData = {};
                    
                    filteredAttendance.forEach(record => {
                        const student = this.state.students.find(s => s.id === record.student_id);
                        if (!student) return;
                        
                        if (!reportData[student.id]) {
                            reportData[student.id] = {
                                student: student,
                                attendance: []
                            };
                        }
                        
                        reportData[student.id].attendance.push(record);
                    });
                    
                    // Calculate statistics
                    const reportStats = {
                        totalStudents: Object.keys(reportData).length,
                        presentDays: 0,
                        absentDays: 0,
                        excusedDays: 0,
                        totalDays: 0
                    };
                    
                    // Generate report HTML
                    let reportHTML = `
                        <div class="p-6">
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Ringkasan Laporan</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">Total Siswa</p>
                                        <p class="text-2xl font-bold text-blue-600">${reportStats.totalStudents}</p>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">Total Hadir</p>
                                        <p class="text-2xl font-bold text-green-600">0</p>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">Total Tidak Hadir</p>
                                        <p class="text-2xl font-bold text-red-600">0</p>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <p class="text-sm text-gray-600">Total Izin/Sakit</p>
                                        <p class="text-2xl font-bold text-yellow-600">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 border-b border-gray-200">
                                        <tr>
                                            <th class="text-left p-4 font-medium text-gray-900">NIS</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Nama</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Kelas</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Hadir</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Tidak Hadir</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Izin/Sakit</th>
                                            <th class="text-left p-4 font-medium text-gray-900">Persentase</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // Process each student
                    Object.values(reportData).forEach(({ student, attendance }) => {
                        const present = attendance.filter(a => a.status === 'present').length;
                        const absent = attendance.filter(a => a.status === 'absent').length;
                        const excused = attendance.filter(a => a.status === 'excused').length;
                        const total = attendance.length;
                        const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                        
                        // Update stats
                        reportStats.presentDays += present;
                        reportStats.absentDays += absent;
                        reportStats.excusedDays += excused;
                        reportStats.totalDays += total;
                        
                        // Determine percentage color
                        let percentageColor = 'text-red-600';
                        if (percentage >= 90) {
                            percentageColor = 'text-green-600';
                        } else if (percentage >= 75) {
                            percentageColor = 'text-yellow-600';
                        }
                        
                        reportHTML += `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-4">${student.nis}</td>
                                <td class="p-4">${student.name}</td>
                                <td class="p-4">${student.class}</td>
                                <td class="p-4">${present}</td>
                                <td class="p-4">${absent}</td>
                                <td class="p-4">${excused}</td>
                                <td class="p-4 font-medium ${percentageColor}">${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    reportHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    // Update report results
                    const reportResults = document.getElementById('reportResults');
                    if (reportResults) {
                        reportResults.innerHTML = reportHTML;
                    }
                    
                    // Update stats
                    const presentDaysEl = reportResults?.querySelector('.bg-green-50 p-4 .text-2xl');
                    const absentDaysEl = reportResults?.querySelector('.bg-red-50 p-4 .text-2xl');
                    const excusedDaysEl = reportResults?.querySelector('.bg-yellow-50 p-4 .text-2xl');
                    
                    if (presentDaysEl) presentDaysEl.textContent = reportStats.presentDays;
                    if (absentDaysEl) absentDaysEl.textContent = reportStats.absentDays;
                    if (excusedDaysEl) excusedDaysEl.textContent = reportStats.excusedDays;
                    
                    // Store report data for export
                    this.currentReportData = {
                        class: reportClass,
                        startDate: reportStartDate,
                        endDate: reportEndDate,
                        stats: reportStats,
                        data: reportData
                    };
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'membuat laporan');
                }
            },
            
            // Export report with improved error handling
            exportReport: function(format) {
                try {
                    if (!this.currentReportData) {
                        window.errorHandler.showError('Tidak ada data laporan untuk diekspor');
                        return;
                    }
                    
                    const { class: reportClass, startDate, endDate, stats, data } = this.currentReportData;
                    
                    if (format === 'excel') {
                        // Create workbook
                        const workbook = XLSX.utils.book_new();
                        
                        // Create summary sheet
                        const summaryData = [
                            { 'Parameter': 'Kelas', 'Value': reportClass || 'Semua Kelas' },
                            { 'Parameter': 'Periode', 'Value': `${startDate} s/d ${endDate}` },
                            { 'Parameter': 'Total Siswa', 'Value': stats.totalStudents },
                            { 'Parameter': 'Total Hadir', 'Value': stats.presentDays },
                            { 'Parameter': 'Total Tidak Hadir', 'Value': stats.absentDays },
                            { 'Parameter': 'Total Izin/Sakit', 'Value': stats.excusedDays }
                        ];
                        
                        const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                        XLSX.utils.book_append_sheet(workbook, summarySheet, 'Ringkasan');
                        
                        // Create detail sheet
                        const detailData = [];
                        
                        Object.values(data).forEach(({ student, attendance }) => {
                            const present = attendance.filter(a => a.status === 'present').length;
                            const absent = attendance.filter(a => a.status === 'absent').length;
                            const excused = attendance.filter(a => a.status === 'excused').length;
                            const total = attendance.length;
                            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                            
                            detailData.push({
                                'NIS': student.nis,
                                'Nama': student.name,
                                'Kelas': student.class,
                                'Hadir': present,
                                'Tidak Hadir': absent,
                                'Izin/Sakit': excused,
                                'Persentase': `${percentage}%`
                            });
                        });
                        
                        const detailSheet = XLSX.utils.json_to_sheet(detailData);
                        XLSX.utils.book_append_sheet(workbook, detailSheet, 'Detail');
                        
                        // Generate filename
                        const filename = `Laporan_Presensi_${reportClass || 'Semua'}_${startDate}_${endDate}.xlsx`;
                        
                        // Save workbook
                        XLSX.writeFile(workbook, filename);
                        
                        this.showToast('Laporan berhasil diekspor ke Excel');
                    } else if (format === 'pdf') {
                        // For PDF export, we would need a PDF library like jsPDF
                        // This is a placeholder implementation
                        window.errorHandler.showError('Export PDF belum diimplementasikan');
                    }
                } catch (error) {
                    window.errorHandler.handleSupabaseError(error, 'mengekspor laporan');
                }
            },
            
            // Print report
            printReport: function() {
                try {
                    if (!this.currentReportData) {
                        window.errorHandler.showError('Tidak ada data laporan untuk dicetak');
                        return;
                    }
                    
                    const { class: reportClass, startDate, endDate, stats, data } = this.currentReportData;
                    
                    // Create print HTML
                    const printHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Laporan Presensi Siswa</title>
                            <style>
                                body {
                                    font-family: Arial, sans-serif;
                                    margin: 20px;
                                    color: #333;
                                }
                                h1, h2, h3 {
                                    margin-bottom: 10px;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin-bottom: 20px;
                                }
                                th, td {
                                    border: 1px solid #ddd;
                                    padding: 8px;
                                    text-align: left;
                                }
                                th {
                                    background-color: #f2f2f2;
                                }
                                .summary {
                                    display: flex;
                                    flex-wrap: wrap;
                                    gap: 20px;
                                    margin-bottom: 20px;
                                }
                                .summary-item {
                                    flex: 1;
                                    min-width: 200px;
                                    padding: 15px;
                                    border-radius: 5px;
                                    text-align: center;
                                }
                                .summary-item h3 {
                                    margin-top: 0;
                                }
                                .summary-item .value {
                                    font-size: 24px;
                                    font-weight: bold;
                                    margin: 10px 0;
                                }
                                .blue { background-color: #e6f7ff; }
                                .green { background-color: #e6ffe6; }
                                .red { background-color: #ffe6e6; }
                                .yellow { background-color: #fff9e6; }
                                @media print {
                                    body { margin: 0; }
                                    .no-print { display: none; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="no-print">
                                <button onclick="window.print()">Cetak</button>
                                <button onclick="window.close()">Tutup</button>
                            </div>
                            
                            <h1>Laporan Presensi Siswa</h1>
                            
                            <h2>Informasi Laporan</h2>
                            <p><strong>Kelas:</strong> ${reportClass || 'Semua Kelas'}</p>
                            <p><strong>Periode:</strong> ${startDate} s/d ${endDate}</p>
                            
                            <h2>Ringkasan</h2>
                            <div class="summary">
                                <div class="summary-item blue">
                                    <h3>Total Siswa</h3>
                                    <div class="value">${stats.totalStudents}</div>
                                </div>
                                <div class="summary-item green">
                                    <h3>Total Hadir</h3>
                                    <div class="value">${stats.presentDays}</div>
                                </div>
                                <div class="summary-item red">
                                    <h3>Total Tidak Hadir</h3>
                                    <div class="value">${stats.absentDays}</div>
                                </div>
                                <div class="summary-item yellow">
                                    <h3>Total Izin/Sakit</h3>
                                    <div class="value">${stats.excusedDays}</div>
                                </div>
                            </div>
                            
                            <h2>Detail Presensi per Siswa</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>NIS</th>
                                        <th>Nama</th>
                                        <th>Kelas</th>
                                        <th>Hadir</th>
                                        <th>Tidak Hadir</th>
                                        <th>Izin/Sakit</th>
                                        <th>Persentase</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    Object.values(data).forEach(({ student, attendance }) => {
                        const present = attendance.filter(a => a.status === 'present').length;
                        const absent = attendance.filter(a => a.status === 'absent').length;
                        const excused = attendance.filter(a => a.status === 'excused').length;
                        const total = attendance.length;
                        const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                        
                        printHTML += `
                            <tr>
                                <td>${student.nis}</td>
                                <td>${student.name}</td>
                                <td>${student.class}</td>
                                <td>${present}</td>
                                <td>${absent}</td>
                                <td>${excused}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    });
                    
                    printHTML += `
                                </tbody>
                            </table>
                            
                            <div class="no-print" style="margin-top: 30px;">
                                <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Open print window
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printHTML);
                    printWindow.document.close();
                } catch (error) {
                    console.error('Error printing report:', error);
                    window.errorHandler.showError('Gagal mencetak laporan');
                }
            },
            
            // Load journal data with improved error handling
            loadJournalData: async function() {
                return window.errorHandler.safeAsyncOperation(async () => {
                    const { data, error } = await this.supabase
                        .from('journals')
                        .select('*')
                        .order('date', { ascending: false });
                    
                    if (error) throw error;
                    
                    this.state.journals = data || [];
                    this.updateJournalList();
                    
                    return data;
                }, 'memuat data jurnal', []);
            },
            
            // Update journal list
            updateJournalList: function() {
                try {
                    const journalList = document.getElementById('journalList');
                    if (!journalList) return;
                    
                    if (this.state.journals.length === 0) {
                        journalList.innerHTML = `
                            <div class="p-6">
                                <div class="empty-state">
                                    <i class="fas fa-book empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Jurnal</h4>
                                    <p class="text-gray-500 mb-4">Mulai dengan menambahkan jurnal pembelajaran pertama Anda.</p>
                                    <button onclick="document.getElementById('addJournalBtn').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Tambah Jurnal Pertama
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    journalList.innerHTML = this.state.journals.map(journal => `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${journal.subject}</h3>
                                    <p class="text-sm text-gray-600">Kelas ${journal.class}  ${this.formatDate(journal.date)}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="edit-journal-btn text-blue-600 hover:text-blue-800" data-id="${journal.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-journal-btn text-red-600 hover:text-red-800" data-id="${journal.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <h4 class="font-medium text-gray-900 mb-1">Kegiatan Pembelajaran:</h4>
                                <p class="text-gray-700">${journal.activity}</p>
                            </div>
                            ${journal.notes ? `
                                <div>
                                    <h4 class="font-medium text-gray-900 mb-1">Catatan Tambahan:</h4>
                                    <p class="text-gray-700">${journal.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    
                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.edit-journal-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const journalId = btn.getAttribute('data-id');
                            this.editJournal(journalId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-journal-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const journalId = btn.getAttribute('data-id');
                            this.deleteJournal(journalId);
                        });
                    });
                } catch (error) {
                    console.error('Error updating journal list:', error);
                    window.errorHandler.showError('Gagal memperbarui daftar jurnal');
                }
            },
            
            // Show journal form
            showJournalForm: function() {
                try {
                    const journalForm = document.getElementById('journalForm');
                    if (journalForm) {
                        journalForm.classList.remove('hidden');
                        
                        // Reset form
                        document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('journalClass').value = '';
                        document.getElementById('journalSubject').value = '';
                        document.getElementById('journalActivity').value = '';
                        document.getElementById('journalNotes').value = '';
                        
                        // Scroll to form
                        journalForm.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    console.error('Error showing journal form:', error);
                    window.errorHandler.showError('Gagal menampilkan form jurnal');
                }
            },
            
            // Hide journal form
            hideJournalForm: function() {
                try {
                    const journalForm = document.getElementById('journalForm');
                    if (journalForm) {
                        journalForm.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding journal form:', error);
                }
            },
            
            // Save journal with improved error handling
            saveJournal: async function() {
                try {
                    const journalDate = document.getElementById('journalDate').value;
                    const journalClass = document.getElementById('journalClass').value;
                    const journalSubject = document.getElementById('journalSubject').value;
                    const journalActivity = document.getElementById('journalActivity').value;
                    const journalNotes = document.getElementById('journalNotes').value;
                    
                    // Validate required fields
                    if (!journalDate || !journalClass || !journalSubject || !journalActivity) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Save to Supabase
                    const { data, error } = await this.supabase
                        .from('journals')
                        .insert([{
                            date: journalDate,
                            class: journalClass,
                            subject: journalSubject,
                            activity: journalActivity,
                            notes: journalNotes || null
                        }])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local state
                    if (data && data.length > 0) {
                        this.state.journals.unshift(data[0]);
                        this.updateJournalList();
                        this.updateRecentActivity();
                    }
                    
                    // Hide form and loading
                    this.hideJournalForm();
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Jurnal berhasil disimpan');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan jurnal');
                }
            },
            
            // Edit journal
            editJournal: function(journalId) {
                try {
                    const journal = this.state.journals.find(j => j.id === journalId);
                    if (!journal) {
                        window.errorHandler.showError('Jurnal tidak ditemukan');
                        return;
                    }
                    
                    const journalForm = document.getElementById('journalForm');
                    if (journalForm) {
                        // Populate form
                        document.getElementById('journalDate').value = journal.date;
                        document.getElementById('journalClass').value = journal.class;
                        document.getElementById('journalSubject').value = journal.subject;
                        document.getElementById('journalActivity').value = journal.activity;
                        document.getElementById('journalNotes').value = journal.notes || '';
                        
                        // Store journal ID for update
                        journalForm.setAttribute('data-journal-id', journalId);
                        
                        // Show form
                        journalForm.classList.remove('hidden');
                        
                        // Scroll to form
                        journalForm.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    console.error('Error editing journal:', error);
                    window.errorHandler.showError('Gagal menampilkan form edit jurnal');
                }
            },
            
            // Update journal with improved error handling
            updateJournal: async function(journalId) {
                try {
                    const journalDate = document.getElementById('journalDate').value;
                    const journalClass = document.getElementById('journalClass').value;
                    const journalSubject = document.getElementById('journalSubject').value;
                    const journalActivity = document.getElementById('journalActivity').value;
                    const journalNotes = document.getElementById('journalNotes').value;
                    
                    // Validate required fields
                    if (!journalDate || !journalClass || !journalSubject || !journalActivity) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Update in Supabase
                    const { data, error } = await this.supabase
                        .from('journals')
                        .update({
                            date: journalDate,
                            class: journalClass,
                            subject: journalSubject,
                            activity: journalActivity,
                            notes: journalNotes || null
                        })
                        .eq('id', journalId)
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local state
                    if (data && data.length > 0) {
                        const index = this.state.journals.findIndex(j => j.id === journalId);
                        if (index !== -1) {
                            this.state.journals[index] = data[0];
                            this.updateJournalList();
                            this.updateRecentActivity();
                        }
                    }
                    
                    // Hide form and loading
                    this.hideJournalForm();
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Jurnal berhasil diperbarui');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'memperbarui jurnal');
                }
            },
            
            // Delete journal with improved error handling
            deleteJournal: async function(journalId) {
                try {
                    if (!confirm('Apakah Anda yakin ingin menghapus jurnal ini?')) {
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Delete from Supabase
                    const { error } = await this.supabase
                        .from('journals')
                        .delete()
                        .eq('id', journalId);
                    
                    if (error) throw error;
                    
                    // Update local state
                    this.state.journals = this.state.journals.filter(j => j.id !== journalId);
                    this.updateJournalList();
                    this.updateRecentActivity();
                    
                    // Hide loading
                    this.hideLoading();
                    
                    // Show success message
                    this.showToast('Jurnal berhasil dihapus');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menghapus jurnal');
                }
            },
            
            // Show teacher profile modal
            showTeacherProfileModal: function() {
                try {
                    const teacherProfileModal = document.getElementById('teacherProfileModal');
                    if (teacherProfileModal) {
                        teacherProfileModal.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error showing teacher profile modal:', error);
                    window.errorHandler.showError('Gagal menampilkan form profil guru');
                }
            },
            
            // Hide teacher profile modal
            hideTeacherProfileModal: function() {
                try {
                    const teacherProfileModal = document.getElementById('teacherProfileModal');
                    if (teacherProfileModal) {
                        teacherProfileModal.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding teacher profile modal:', error);
                }
            },
            
            // Handle teacher photo select
            handleTeacherPhotoSelect: function(file) {
                try {
                    // Check file type
                    if (!file.type.match('image.*')) {
                        window.errorHandler.showError('Harap pilih file gambar');
                        return;
                    }
                    
                    // Check file size (max 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        window.errorHandler.showError('Ukuran file tidak boleh lebih dari 2MB');
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const profilePhotoImg = document.getElementById('profilePhotoImg');
                        const profileIcon = document.getElementById('profileIcon');
                        const removePhotoBtn = document.getElementById('removePhotoBtn');
                        
                        if (profilePhotoImg && profileIcon && removePhotoBtn) {
                            profilePhotoImg.src = e.target.result;
                            profilePhotoImg.classList.remove('hidden');
                            profileIcon.classList.add('hidden');
                            removePhotoBtn.classList.remove('hidden');
                        }
                        
                        // Store file for upload
                        this.teacherPhotoFile = file;
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error handling teacher photo select:', error);
                    window.errorHandler.showError('Gagal memproses foto yang dipilih');
                }
            },
            
            // Remove teacher photo
            removeTeacherPhoto: function() {
                try {
                    const profilePhotoImg = document.getElementById('profilePhotoImg');
                    const profileIcon = document.getElementById('profileIcon');
                    const removePhotoBtn = document.getElementById('removePhotoBtn');
                    const photoInput = document.getElementById('photoInput');
                    
                    if (profilePhotoImg && profileIcon && removePhotoBtn && photoInput) {
                        profilePhotoImg.classList.add('hidden');
                        profileIcon.classList.remove('hidden');
                        removePhotoBtn.classList.add('hidden');
                        photoInput.value = '';
                        
                        // Clear stored file
                        this.teacherPhotoFile = null;
                    }
                } catch (error) {
                    console.error('Error removing teacher photo:', error);
                    window.errorHandler.showError('Gagal menghapus foto');
                }
            },
            
            // Save teacher profile with improved error handling
            saveTeacherProfile: async function() {
                try {
                    const teacherNameInput = document.getElementById('teacherNameInput').value;
                    const teacherSubjectInput = document.getElementById('teacherSubjectInput').value;
                    const teacherNIP = document.getElementById('teacherNIP').value;
                    const teacherEmail = document.getElementById('teacherEmail').value;
                    const teacherPhone = document.getElementById('teacherPhone').value;
                    
                    // Validate required fields
                    if (!teacherNameInput || !teacherSubjectInput) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    // Show loading
                    this.showLoading();
                    
                    // Prepare profile data
                    const profileData = {
                        name: teacherNameInput,
                        subject: teacherSubjectInput,
                        nip: teacherNIP || null,
                        email: teacherEmail || null,
                        phone: teacherPhone || null
                    };
                    
                    // Upload photo if selected
                    if (this.teacherPhotoFile) {
                        try {
                            const fileName = `teacher_${Date.now()}`;
                            const { data: uploadData, error: uploadError } = await this.supabase.storage
                                .from('teacher_photos')
                                .upload(fileName, this.teacherPhotoFile);
                            
                            if (uploadError) throw uploadError;
                            
                            // Get public URL
                            const { data: urlData } = this.supabase.storage
                                .from('teacher_photos')
                                .getPublicUrl(fileName);
                            
                            if (urlData && urlData.publicUrl) {
                                profileData.photo_url = urlData.publicUrl;
                            }
                        } catch (uploadError) {
                            console.error('Error uploading teacher photo:', uploadError);
                            window.errorHandler.showError('Gagal mengupload foto, profil disimpan tanpa foto');
                        }
                    }
                    
                    // Check if profile exists
                    if (this.state.teacherProfile) {
                        // Update existing profile
                        const { data, error } = await this.supabase
                            .from('teacher_profiles')
                            .update(profileData)
                            .eq('id', this.state.teacherProfile.id)
                            .select();
                        
                        if (error) throw error;
                        
                        // Update local state
                        if (data && data.length > 0) {
                            this.state.teacherProfile = data[0];
                            this.updateTeacherProfileUI(data[0]);
                        }
                    } else {
                        // Create new profile
                        const { data, error } = await this.supabase
                            .from('teacher_profiles')
                            .insert([profileData])
                            .select();
                        
                        if (error) throw error;
                        
                        // Update local state
                        if (data && data.length > 0) {
                            this.state.teacherProfile = data[0];
                            this.updateTeacherProfileUI(data[0]);
                        }
                    }
                    
                    // Hide modal and loading
                    this.hideTeacherProfileModal();
                    this.hideLoading();
                    
                    // Clear stored file
                    this.teacherPhotoFile = null;
                    
                    // Show success message
                    this.showToast('Profil guru berhasil disimpan');
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan profil guru');
                }
            },
            
            // Show loading overlay
            showLoading: function() {
                try {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error showing loading overlay:', error);
                }
            },
            
            // Hide loading overlay
            hideLoading: function() {
                try {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error hiding loading overlay:', error);
                }
            },
            
            // Show toast notification
            showToast: function(message, type = 'success') {
                try {
                    const toast = document.getElementById('toast');
                    const toastMessage = document.getElementById('toastMessage');
                    
                    if (toast && toastMessage) {
                        // Set message
                        toastMessage.textContent = message;
                        
                        // Set background color based on type
                        toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50';
                        
                        if (type === 'success') {
                            toast.classList.add('bg-green-500', 'text-white');
                        } else if (type === 'error') {
                            toast.classList.add('bg-red-500', 'text-white');
                        } else if (type === 'warning') {
                            toast.classList.add('bg-yellow-500', 'text-white');
                        } else {
                            toast.classList.add('bg-blue-500', 'text-white');
                        }
                        
                        // Show toast
                        setTimeout(() => {
                            toast.classList.remove('translate-x-full');
                        }, 100);
                        
                        // Hide toast after 3 seconds
                        setTimeout(() => {
                            toast.classList.add('translate-x-full');
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Error showing toast:', error);
                }
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
        });
    </script>
</body>
</html>
