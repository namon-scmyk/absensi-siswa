<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Absensi Siswa - Dashboard Guru</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Absensi Siswa">
    <meta name="description" content="Aplikasi manajemen presensi siswa untuk guru">
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; font-family: system-ui, -apple-system, sans-serif; }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .mobile-padding { padding: 1rem; }
            .mobile-button { min-height: 44px; min-width: 44px; }
        }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #e2e8f0;
            z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        
        .connection-status {
            position: fixed; top: 10px; right: 10px; z-index: 100;
            padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;
        }
        .online { background: #10b981; color: white; }
        .offline { background: #ef4444; color: white; }
        
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 9999; color: white;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top: 3px solid white; width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
        }
        
        .error-toast {
            position: fixed; top: 4rem; right: 1rem; background: #ef4444;
            color: white; padding: 1rem; border-radius: 0.5rem; z-index: 1000;
            max-width: 80%; transform: translateX(120%); transition: transform 0.3s;
        }
        .error-toast.show { transform: translateX(0); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-graduation-cap text-4xl"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2">Absensi Siswa</h1>
        <p class="text-blue-100">Memuat aplikasi...</p>
        <div class="mt-4"><div class="spinner"></div></div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connecting">
        <i class="fas fa-wifi mr-1"></i><span>Connecting...</span>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="error-toast">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center font-bold">
                <i class="fas fa-exclamation-circle mr-2"></i>Kesalahan
            </div>
            <button id="closeErrorToast" class="text-white">&times;</button>
        </div>
        <div id="errorMessage" class="text-sm"></div>
    </div>

    <!-- Mobile Header -->
    <header class="lg:hidden bg-white shadow-sm">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-900">Absensi Siswa</h1>
                    <p class="text-xs text-gray-500" id="currentDate"></p>
                </div>
            </div>
            <button id="profileBtn" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-gray-600 text-sm"></i>
            </button>
        </div>
    </header>

    <div class="flex h-screen">
        <!-- Desktop Sidebar -->
        <aside class="hidden lg:flex lg:flex-col lg:w-80 bg-white shadow-lg">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Absensi Siswa</h1>
                        <p class="text-sm text-gray-500">Dashboard Guru</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="nav-item flex items-center space-x-3 p-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
                    <i class="fas fa-home w-5"></i><span>Dashboard</span>
                </a>
                <a href="#students" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-users w-5"></i><span>Manajemen Siswa</span>
                </a>
                <a href="#attendance" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-check-circle w-5"></i><span>Input Presensi</span>
                </a>
                <a href="#reports" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-chart-bar w-5"></i><span>Rekap Presensi</span>
                </a>
                <a href="#journal" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-book w-5"></i><span>Rekap Jurnal</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer" id="teacherProfile">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white" id="teacherIcon"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-900" id="teacherName">Guru</p>
                        <p class="text-sm text-gray-500" id="teacherSubject">Mata Pelajaran</p>
                    </div>
                    <i class="fas fa-edit text-gray-400"></i>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto pb-20 lg:pb-0">
            <!-- Dashboard View -->
            <div id="dashboardView" class="view-content p-4 lg:p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h2>
                    <p class="text-gray-600">Ringkasan kehadiran siswa hari ini</p>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex items-center justify-between">
                            <div><p class="text-sm text-gray-600">Total Siswa</p><p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p></div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-users text-blue-600"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex items-center justify-between">
                            <div><p class="text-sm text-gray-600">Hadir Hari Ini</p><p class="text-2xl font-bold text-green-600" id="presentToday">0</p></div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-check-circle text-green-600"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex items-center justify-between">
                            <div><p class="text-sm text-gray-600">Tidak Hadir</p><p class="text-2xl font-bold text-red-600" id="absentToday">0</p></div>
                            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center"><i class="fas fa-times-circle text-red-600"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex items-center justify-between">
                            <div><p class="text-sm text-gray-600">Izin/Sakit</p><p class="text-2xl font-bold text-yellow-600" id="excusedToday">0</p></div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"><i class="fas fa-exclamation-circle text-yellow-600"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <button class="quick-action-btn bg-blue-500 text-white p-4 rounded-xl mobile-button" data-view="attendance">
                        <i class="fas fa-plus text-xl mb-2"></i><p class="font-medium">Input Presensi</p>
                    </button>
                    <button class="quick-action-btn bg-green-500 text-white p-4 rounded-xl mobile-button" data-view="reports">
                        <i class="fas fa-chart-line text-xl mb-2"></i><p class="font-medium">Lihat Rekap</p>
                    </button>
                    <button class="quick-action-btn bg-purple-500 text-white p-4 rounded-xl mobile-button" data-view="students">
                        <i class="fas fa-users text-xl mb-2"></i><p class="font-medium">Kelola Siswa</p>
                    </button>
                    <button class="quick-action-btn bg-orange-500 text-white p-4 rounded-xl mobile-button" data-view="journal">
                        <i class="fas fa-book text-xl mb-2"></i><p class="font-medium">Tulis Jurnal</p>
                    </button>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold mb-4">Tren Kehadiran</h3><canvas id="attendanceChart"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold mb-4">Performa Kelas</h3><canvas id="classChart"></canvas></div>
                </div>
            </div>

            <!-- Students Management View -->
            <div id="studentsView" class="view-content hidden p-4 lg:p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Manajemen Siswa</h2>
                    <p class="text-gray-600">Kelola data siswa dan informasi kelas</p>
                </div>

                <div class="flex flex-wrap gap-2 mb-6">
                    <button id="addStudentBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg mobile-button">
                        <i class="fas fa-plus mr-2"></i>Tambah Siswa
                    </button>
                    <button id="importStudentsBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg mobile-button">
                        <i class="fas fa-file-import mr-2"></i>Import Excel
                    </button>
                    <button id="exportStudentsBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg mobile-button">
                        <i class="fas fa-file-export mr-2"></i>Export Excel
                    </button>
                </div>

                <!-- Filter -->
                <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <select id="classFilter" class="p-3 border border-gray-300 rounded-lg">
                            <option value="">Semua Kelas</option>
                            <option value="X-1">Kelas X-1</option><option value="X-2">Kelas X-2</option>
                            <option value="X-3">Kelas X-3</option><option value="X-4">Kelas X-4</option>
                        </select>
                        <input type="text" id="searchStudent" placeholder="Cari nama atau NIS..." class="p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <!-- Students Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50"><tr>
                                <th class="text-left p-4">NIS</th><th class="text-left p-4">Nama Siswa</th>
                                <th class="text-left p-4">Kelas</th><th class="text-left p-4">Kehadiran</th>
                                <th class="text-left p-4">Aksi</th>
                            </tr></thead>
                            <tbody id="studentsTableBody">
                                <tr><td colspan="5" class="p-8 text-center text-gray-500">Memuat data siswa...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Input View -->
            <div id="attendanceView" class="view-content hidden p-4 lg:p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Input Presensi</h2>
                    <p class="text-gray-600">Catat kehadiran siswa untuk hari ini</p>
                </div>

                <!-- Attendance Form -->
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div><label class="block text-sm font-medium mb-2">Pilih Kelas</label>
                            <select id="attendanceClass" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">Pilih Kelas</option>
                                <option value="X-1">Kelas X-1</option><option value="X-2">Kelas X-2</option>
                                <option value="X-3">Kelas X-3</option><option value="X-4">Kelas X-4</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Tanggal</label>
                            <input type="date" id="attendanceDate" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Mata Pelajaran</label>
                            <input type="text" id="attendanceSubject" placeholder="Contoh: Matematika" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="markAllPresent" class="bg-green-500 text-white px-4 py-2 rounded-lg mobile-button">
                            <i class="fas fa-check mr-2"></i>Semua Hadir
                        </button>
                        <button id="markAllAbsent" class="bg-red-500 text-white px-4 py-2 rounded-lg mobile-button">
                            <i class="fas fa-times mr-2"></i>Semua Tidak Hadir
                        </button>
                    </div>
                </div>

                <!-- Students List -->
                <div id="attendanceList" class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b"><h3 class="text-lg font-semibold">Daftar Siswa</h3></div>
                    <div id="attendanceStudentsList" class="p-6">
                        <div class="text-center text-gray-500">Pilih kelas untuk menampilkan daftar siswa</div>
                    </div>
                    <div class="p-6 border-t">
                        <button id="saveAttendance" class="w-full bg-blue-500 text-white py-3 rounded-lg mobile-button disabled:opacity-50" disabled>
                            <i class="fas fa-save mr-2"></i>Simpan Presensi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="view-content hidden p-4 lg:p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Rekap Presensi</h2>
                    <p class="text-gray-600">Analisis dan laporan kehadiran siswa</p>
                </div>

                <!-- Filter -->
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm font-medium mb-2">Kelas</label>
                            <select id="reportClass" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">Semua Kelas</option>
                                <option value="X-1">Kelas X-1</option><option value="X-2">Kelas X-2</option>
                                <option value="X-3">Kelas X-3</option><option value="X-4">Kelas X-4</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Dari Tanggal</label>
                            <input type="date" id="reportStartDate" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Sampai Tanggal</label>
                            <input type="date" id="reportEndDate" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-end">
                            <button id="generateReport" class="w-full bg-blue-500 text-white py-3 rounded-lg mobile-button">
                                <i class="fas fa-search mr-2"></i>Generate
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Results -->
                <div id="reportResults" class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b"><h3 class="text-lg font-semibold">Hasil Rekap</h3></div>
                    <div class="p-6 text-center text-gray-500">Pilih filter dan klik Generate untuk melihat rekap</div>
                </div>
            </div>

            <!-- Journal View -->
            <div id="journalView" class="view-content hidden p-4 lg:p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Rekap Jurnal</h2>
                    <p class="text-gray-600">Catat dan kelola jurnal pembelajaran harian</p>
                </div>

                <button id="addJournalBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg mb-6 mobile-button">
                    <i class="fas fa-plus mr-2"></i>Tambah Jurnal
                </button>

                <!-- Journal Form -->
                <div id="journalForm" class="bg-white p-6 rounded-xl shadow-sm mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Tambah Jurnal Baru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-sm font-medium mb-2">Tanggal</label>
                            <input type="date" id="journalDate" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Kelas</label>
                            <select id="journalClass" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">Pilih Kelas</option>
                                <option value="X-1">Kelas X-1</option><option value="X-2">Kelas X-2</option>
                                <option value="X-3">Kelas X-3</option><option value="X-4">Kelas X-4</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-medium mb-2">Mata Pelajaran</label>
                            <input type="text" id="journalSubject" placeholder="Contoh: Matematika" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="mb-4"><label class="block text-sm font-medium mb-2">Kegiatan Pembelajaran</label>
                        <textarea id="journalActivity" rows="4" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button id="saveJournal" class="bg-blue-500 text-white px-6 py-2 rounded-lg mobile-button">
                            <i class="fas fa-save mr-2"></i>Simpan Jurnal
                        </button>
                        <button id="cancelJournal" class="bg-gray-500 text-white px-6 py-2 rounded-lg mobile-button">
                            <i class="fas fa-times mr-2"></i>Batal
                        </button>
                    </div>
                </div>

                <!-- Journal List -->
                <div id="journalList" class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b"><h3 class="text-lg font-semibold">Riwayat Jurnal</h3></div>
                    <div class="p-6 text-center text-gray-500">Belum ada jurnal</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav lg:hidden">
        <div class="flex justify-around py-2">
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-blue-600" data-view="dashboard">
                <i class="fas fa-home text-xl mb-1"></i><span class="text-xs">Dashboard</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="students">
                <i class="fas fa-users text-xl mb-1"></i><span class="text-xs">Siswa</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="attendance">
                <i class="fas fa-check-circle text-xl mb-1"></i><span class="text-xs">Presensi</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="reports">
                <i class="fas fa-chart-bar text-xl mb-1"></i><span class="text-xs">Rekap</span>
            </button>
            <button class="nav-mobile-btn flex flex-col items-center p-2 text-gray-400" data-view="journal">
                <i class="fas fa-book text-xl mb-1"></i><span class="text-xs">Jurnal</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b"><h3 id="studentModalTitle" class="text-lg font-semibold">Tambah Siswa Baru</h3></div>
            <form id="studentForm" class="p-6 space-y-4">
                <div><label class="block text-sm font-medium mb-2">NIS *</label>
                    <input type="text" id="studentNIS" required class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div><label class="block text-sm font-medium mb-2">Nama Lengkap *</label>
                    <input type="text" id="studentName" required class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div><label class="block text-sm font-medium mb-2">Kelas *</label>
                    <select id="studentClass" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Pilih Kelas</option>
                        <option value="X-1">Kelas X-1</option><option value="X-2">Kelas X-2</option>
                        <option value="X-3">Kelas X-3</option><option value="X-4">Kelas X-4</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium mb-2">Jenis Kelamin *</label>
                    <select id="studentGender" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Pilih</option><option value="L">Laki-laki</option><option value="P">Perempuan</option>
                    </select>
                </div>
            </form>
            <div class="p-6 border-t flex space-x-3">
                <button id="cancelStudent" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">Batal</button>
                <button id="saveStudent" class="flex-1 bg-blue-500 text-white py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl"><div class="flex items-center space-x-3">
            <div class="spinner"></div><span class="text-gray-700">Memproses...</span>
        </div></div>
    </div>

    <script>
        // Error Handler
        window.errorHandler = {
            showError: function(message, details = null) {
                console.error('Error:', message, details);
                const errorToast = document.getElementById('errorToast');
                const errorMessage = document.getElementById('errorMessage');
                if (errorToast && errorMessage) {
                    errorMessage.textContent = message;
                    errorToast.classList.add('show');
                    setTimeout(() => errorToast.classList.remove('show'), 5000);
                }
            },
            handleSupabaseError: function(error, operation) {
                let message = `Terjadi kesalahan saat ${operation}`;
                if (error && error.message) {
                    if (error.code === 'PGRST116') message = 'Data tidak ditemukan';
                    else if (error.code === '23505') message = 'Data sudah ada';
                    else if (error.code === '42501') message = 'Tidak memiliki izin';
                    else message = `${message}: ${error.message}`;
                }
                this.showError(message, error);
                return { success: false, error: message };
            }
        };

        // Initialize Supabase
        window.initializeSupabase = function() {
            try {
                const supabaseUrl = 'https://lleviwszkjhoyqvpiapu.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZXZpd3N6a2pob3lxdnBpYXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MDc3MjcsImV4cCI6MjA3NDA4MzcyN30.YP6WYMiwJch6lhk2AiLUtUwyGZ5soO382MjqKD4jwg4';
                return window.supabase.createClient(supabaseUrl, supabaseKey);
            } catch (error) {
                window.errorHandler.handleSupabaseError(error, 'menginisialisasi Supabase');
                return null;
            }
        };

        // Main Application
        window.app = {
            state: { currentView: 'dashboard', students: [], attendance: [], journals: [], teacherProfile: null },
            
            init: async function() {
                try {
                    this.supabase = window.initializeSupabase();
                    if (!this.supabase) throw new Error('Failed to initialize Supabase');
                    
                    this.setupConnectionStatus();
                    await Promise.all([this.loadTeacherProfile(), this.loadStudents(), this.loadDashboardData()]);
                    this.setupEventListeners();
                    
                    setTimeout(() => {
                        const splashScreen = document.getElementById('splashScreen');
                        if (splashScreen) {
                            splashScreen.style.opacity = '0';
                            setTimeout(() => splashScreen.style.display = 'none', 500);
                        }
                    }, 1000);
                    
                    this.updateCurrentDate();
                    this.initializeCharts();
                    console.log('Application initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize application:', error);
                    window.errorHandler.handleSupabaseError(error, 'menginisialisasi aplikasi');
                    document.getElementById('splashScreen').style.display = 'none';
                }
            },

            // Teacher Profile
            loadTeacherProfile: async function() {
                try {
                    const { data, error } = await this.supabase.from('teacher_profiles').select('*').single();
                    if (error) throw error;
                    this.state.teacherProfile = data;
                    this.updateTeacherProfileUI(data);
                    return data;
                } catch (error) {
                    window.errorHandler.handleSupabaseError(error, 'memuat profil guru');
                    return {};
                }
            },

            updateTeacherProfileUI: function(profile) {
                const teacherName = document.getElementById('teacherName');
                const teacherSubject = document.getElementById('teacherSubject');
                if (teacherName) teacherName.textContent = profile.name || 'Guru';
                if (teacherSubject) teacherSubject.textContent = profile.subject || 'Mata Pelajaran';
            },

            // Students Management
            loadStudents: async function() {
                try {
                    const { data, error } = await this.supabase.from('students').select('*').order('name');
                    if (error) throw error;
                    this.state.students = data || [];
                    this.updateStudentsTable();
                    return data;
                } catch (error) {
                    window.errorHandler.handleSupabaseError(error, 'memuat data siswa');
                    return [];
                }
            },

            updateStudentsTable: function() {
                try {
                    const studentsTableBody = document.getElementById('studentsTableBody');
                    if (!studentsTableBody) return;
                    
                    if (this.state.students.length === 0) {
                        studentsTableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">Belum ada data siswa</td></tr>';
                        return;
                    }
                    
                    studentsTableBody.innerHTML = this.state.students.map(student => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4">${student.nis}</td>
                            <td class="p-4">${student.name}</td>
                            <td class="p-4">${student.class}</td>
                            <td class="p-4">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 50%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">50%</span>
                                </div>
                            </td>
                            <td class="p-4">
                                <div class="flex space-x-2">
                                    <button class="edit-student-btn text-blue-600" data-id="${student.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-student-btn text-red-600" data-id="${student.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    window.errorHandler.showError('Gagal memperbarui tabel siswa');
                }
            },

            // Dashboard Data
            loadDashboardData: async function() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const { data, error } = await this.supabase.from('attendance').select('*').eq('date', today);
                    if (error) throw error;
                    this.state.attendance = data || [];
                    this.updateDashboardStats();
                    return data;
                } catch (error) {
                    window.errorHandler.handleSupabaseError(error, 'memuat data dashboard');
                    return [];
                }
            },

            updateDashboardStats: function() {
                try {
                    const totalStudents = this.state.students.length;
                    const today = new Date().toISOString().split('T')[0];
                    const todayAttendance = this.state.attendance.filter(record => record.date === today);
                    
                    const presentToday = todayAttendance.filter(r => r.status === 'present').length;
                    const absentToday = todayAttendance.filter(r => r.status === 'absent').length;
                    const excusedToday = todayAttendance.filter(r => r.status === 'excused').length;
                    
                    document.getElementById('totalStudents').textContent = totalStudents;
                    document.getElementById('presentToday').textContent = presentToday;
                    document.getElementById('absentToday').textContent = absentToday;
                    document.getElementById('excusedToday').textContent = excusedToday;
                } catch (error) {
                    console.error('Error updating dashboard stats:', error);
                }
            },

            // Attendance
            loadAttendanceStudents: async function() {
                try {
                    const attendanceClass = document.getElementById('attendanceClass').value;
                    const attendanceStudentsList = document.getElementById('attendanceStudentsList');
                    const saveAttendanceBtn = document.getElementById('saveAttendance');
                    
                    if (!attendanceClass) {
                        attendanceStudentsList.innerHTML = '<div class="text-center text-gray-500">Pilih kelas untuk menampilkan daftar siswa</div>';
                        saveAttendanceBtn.disabled = true;
                        return;
                    }
                    
                    this.showLoading();
                    const classStudents = this.state.students.filter(student => student.class === attendanceClass);
                    
                    if (classStudents.length === 0) {
                        attendanceStudentsList.innerHTML = '<div class="text-center text-gray-500">Tidak ada siswa di kelas ini</div>';
                        saveAttendanceBtn.disabled = true;
                        this.hideLoading();
                        return;
                    }
                    
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    const todayAttendance = this.state.attendance.filter(
                        record => record.date === attendanceDate && 
                        classStudents.some(student => student.id === record.student_id)
                    );
                    
                    let attendanceListHTML = '<div class="space-y-3">';
                    classStudents.forEach(student => {
                        const existingRecord = todayAttendance.find(record => record.student_id === student.id);
                        const status = existingRecord ? existingRecord.status : '';
                        
                        attendanceListHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">${student.name}</p>
                                        <p class="text-sm text-gray-600">${student.nis}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm ${
                                        status === 'present' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'
                                    }" data-student-id="${student.id}" data-status="present">Hadir</button>
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm ${
                                        status === 'absent' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'
                                    }" data-student-id="${student.id}" data-status="absent">Tidak Hadir</button>
                                    <button class="attendance-btn px-3 py-1 rounded-lg text-sm ${
                                        status === 'excused' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'
                                    }" data-student-id="${student.id}" data-status="excused">Izin/Sakit</button>
                                </div>
                            </div>
                        `;
                    });
                    attendanceListHTML += '</div>';
                    
                    attendanceStudentsList.innerHTML = attendanceListHTML;
                    saveAttendanceBtn.disabled = false;
                    
                    document.querySelectorAll('.attendance-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const studentId = btn.getAttribute('data-student-id');
                            const status = btn.getAttribute('data-status');
                            
                            document.querySelectorAll(`.attendance-btn[data-student-id="${studentId}"]`).forEach(b => {
                                b.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-white');
                                b.classList.add('bg-gray-200', 'text-gray-700');
                            });
                            
                            btn.classList.remove('bg-gray-200', 'text-gray-700');
                            if (status === 'present') btn.classList.add('bg-green-500', 'text-white');
                            else if (status === 'absent') btn.classList.add('bg-red-500', 'text-white');
                            else if (status === 'excused') btn.classList.add('bg-yellow-500', 'text-white');
                        });
                    });
                    
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'memuat daftar siswa untuk presensi');
                }
            },

            saveAttendance: async function() {
                try {
                    const attendanceClass = document.getElementById('attendanceClass').value;
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    const attendanceSubject = document.getElementById('attendanceSubject').value;
                    
                    if (!attendanceClass || !attendanceDate || !attendanceSubject) {
                        window.errorHandler.showError('Harap lengkapi Kelas, Tanggal, dan Mata Pelajaran');
                        return;
                    }
                    
                    this.showLoading();
                    const classStudents = this.state.students.filter(student => student.class === attendanceClass);
                    
                    if (classStudents.length === 0) {
                        window.errorHandler.showError('Tidak ada siswa di kelas ini');
                        this.hideLoading();
                        return;
                    }
                    
                    const attendanceData = [];
                    classStudents.forEach(student => {
                        const activeBtn = document.querySelector(
                            `.attendance-btn[data-student-id="${student.id}"].bg-green-500, 
                             .attendance-btn[data-student-id="${student.id}"].bg-red-500, 
                             .attendance-btn[data-student-id="${student.id}"].bg-yellow-500`
                        );
                        
                        if (activeBtn) {
                            const status = activeBtn.getAttribute('data-status');
                            attendanceData.push({ student_id: student.id, date: attendanceDate, subject: attendanceSubject, status: status });
                        }
                    });
                    
                    if (attendanceData.length === 0) {
                        window.errorHandler.showError('Tidak ada data presensi yang dipilih');
                        this.hideLoading();
                        return;
                    }
                    
                    const { error } = await this.supabase.from('attendance').insert(attendanceData);
                    if (error) throw error;
                    
                    await this.loadAttendanceData();
                    this.updateDashboardStats();
                    
                    this.hideLoading();
                    this.showToast(`Presensi berhasil disimpan untuk ${attendanceData.length} siswa`);
                    
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan presensi');
                }
            },

            // Journal Management
            loadJournalData: async function() {
                try {
                    const { data, error } = await this.supabase.from('journals').select('*').order('date', { ascending: false });
                    if (error) throw error;
                    this.state.journals = data || [];
                    this.updateJournalList();
                    return data;
                } catch (error) {
                    window.errorHandler.handleSupabaseError(error, 'memuat data jurnal');
                    return [];
                }
            },

            saveJournal: async function() {
                try {
                    const journalDate = document.getElementById('journalDate').value;
                    const journalClass = document.getElementById('journalClass').value;
                    const journalSubject = document.getElementById('journalSubject').value;
                    const journalActivity = document.getElementById('journalActivity').value;
                    const journalNotes = document.getElementById('journalNotes').value;
                    
                    if (!journalDate || !journalClass || !journalSubject || !journalActivity) {
                        window.errorHandler.showError('Harap lengkapi semua field yang wajib diisi');
                        return;
                    }
                    
                    this.showLoading();
                    const journalData = { date: journalDate, class: journalClass, subject: journalSubject, activity: journalActivity, notes: journalNotes || null };
                    
                    const { data, error } = await this.supabase.from('journals').insert([journalData]).select();
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        this.state.journals.unshift(data[0]);
                        this.updateJournalList();
                    }
                    
                    this.hideJournalForm();
                    this.hideLoading();
                    this.showToast('Jurnal berhasil disimpan');
                    
                } catch (error) {
                    this.hideLoading();
                    window.errorHandler.handleSupabaseError(error, 'menyimpan jurnal');
                }
            },

            updateJournalList: function() {
                try {
                    const journalList = document.getElementById('journalList');
                    if (!journalList) return;
                    
                    if (this.state.journals.length === 0) {
                        journalList.innerHTML = '<div class="p-6 text-center text-gray-500">Belum ada jurnal</div>';
                        return;
                    }
                    
                    journalList.innerHTML = this.state.journals.map(journal => `
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">${journal.subject}</h3>
                                    <p class="text-sm text-gray-600">Kelas ${journal.class} â€¢ ${new Date(journal.date).toLocaleDateString('id-ID')}</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <h4 class="font-medium mb-1">Kegiatan Pembelajaran:</h4>
                                <p class="text-gray-700">${journal.activity}</p>
                            </div>
                            ${journal.notes ? `<div><h4 class="font-medium mb-1">Catatan:</h4><p class="text-gray-700">${journal.notes}</p></div>` : ''}
                        </div>
                    `).join('');
                } catch (error) {
                    window.errorHandler.showError('Gagal memperbarui daftar jurnal');
                }
            },

            // Template Download
            downloadTemplate: function() {
                try {
                    const templateData = [
                        { 'NIS': '202401001', 'Nama': 'Ahmad Budi', 'Kelas': 'X-1', 'Gender': 'L' },
                        { 'NIS': '202401002', 'Nama': 'Siti Rahayu', 'Kelas': 'X-1', 'Gender': 'P' }
                    ];
                    
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.json_to_sheet(templateData);
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Template Siswa');
                    XLSX.writeFile(workbook, 'Template_Import_Siswa.xlsx');
                    this.showToast('Template berhasil didownload');
                } catch (error) {
                    window.errorHandler.showError('Gagal download template');
                }
            },

            // Utility Functions
            showView: function(viewName) {
                document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
                const selectedView = document.getElementById(`${viewName}View`);
                if (selectedView) selectedView.classList.remove('hidden');
                
                this.state.currentView = viewName;
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
                    item.classList.add('text-gray-600');
                    if (item.getAttribute('href') === `#${viewName}`) {
                        item.classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
                    }
                });
                
                document.querySelectorAll('.nav-mobile-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-400');
                    if (btn.getAttribute('data-view') === viewName) {
                        btn.classList.add('text-blue-600');
                    }
                });
            },

            showLoading: function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.remove('hidden');
            },

            hideLoading: function() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            },

            showToast: function(message) {
                console.log('Toast:', message);
                // Simple alert untuk sementara
                alert(message);
            },

            updateCurrentDate: function() {
                const currentDateEl = document.getElementById('currentDate');
                if (currentDateEl) {
                    const today = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    currentDateEl.textContent = today;
                }
            },

            initializeCharts: function() {
                try {
                    const attendanceChartCtx = document.getElementById('attendanceChart');
                    if (attendanceChartCtx) {
                        this.attendanceChart = new Chart(attendanceChartCtx, {
                            type: 'line', data: { labels: [], datasets: [] },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                    const classChartCtx = document.getElementById('classChart');
                    if (classChartCtx) {
                        this.classChart = new Chart(classChartCtx, {
                            type: 'bar', data: { labels: [], datasets: [] },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                } catch (error) {
                    console.warn('Chart initialization skipped');
                }
            },

            setupConnectionStatus: function() {
                const updateStatus = () => {
                    const connectionStatus = document.getElementById('connectionStatus');
                    if (!connectionStatus) return;
                    const isOnline = navigator.onLine;
                    if (isOnline) {
                        connectionStatus.className = 'connection-status online';
                        connectionStatus.innerHTML = '<i class="fas fa-wifi mr-1"></i><span>Online</span>';
                    } else {
                        connectionStatus.className = 'connection-status offline';
                        connectionStatus.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i><span>Offline</span>';
                    }
                };
                updateStatus();
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);
            },

            setupEventListeners: function() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = e.currentTarget.getAttribute('href').substring(1);
                        this.showView(view);
                    });
                });
                
                document.querySelectorAll('.nav-mobile-btn, .quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const view = btn.getAttribute('data-view');
                        this.showView(view);
                    });
                });

                // Student Management
                document.getElementById('addStudentBtn').addEventListener('click', () => {
                    document.getElementById('studentModal').classList.remove('hidden');
                });

                document.getElementById('saveStudent').addEventListener('click', async () => {
                    const nis = document.getElementById('studentNIS').value;
                    const name = document.getElementById('studentName').value;
                    const studentClass = document.getElementById('studentClass').value;
                    const gender = document.getElementById('studentGender').value;
                    
                    if (!nis || !name || !studentClass || !gender) {
                        window.errorHandler.showError('Harap lengkapi semua field');
                        return;
                    }
                    
                    this.showLoading();
                    try {
                        const { error } = await this.supabase.from('students').insert([{ nis, name, class: studentClass, gender }]);
                        if (error) throw error;
                        await this.loadStudents();
                        document.getElementById('studentModal').classList.add('hidden');
                        this.showToast('Siswa berhasil ditambahkan');
                    } catch (error) {
                        window.errorHandler.handleSupabaseError(error, 'menyimpan siswa');
                    }
                    this.hideLoading();
                });

                document.getElementById('cancelStudent').addEventListener('click', () => {
                    document.getElementById('studentModal').classList.add('hidden');
                });

                // Attendance
                document.getElementById('attendanceClass').addEventListener('change', () => this.loadAttendanceStudents());
                document.getElementById('markAllPresent').addEventListener('click', () => {
                    document.querySelectorAll('.attendance-btn[data-status="present"]').forEach(btn => btn.click());
                });
                document.getElementById('markAllAbsent').addEventListener('click', () => {
                    document.querySelectorAll('.attendance-btn[data-status="absent"]').forEach(btn => btn.click());
                });
                document.getElementById('saveAttendance').addEventListener('click', () => this.saveAttendance());

                // Journal
                document.getElementById('addJournalBtn').addEventListener('click', () => {
                    document.getElementById('journalForm').classList.remove('hidden');
                });
                document.getElementById('saveJournal').addEventListener('click', () => this.saveJournal());
                document.getElementById('cancelJournal').addEventListener('click', () => {
                    document.getElementById('journalForm').classList.add('hidden');
                });

                // Template Download
                document.getElementById('importStudentsBtn').addEventListener('click', () => {
                    this.downloadTemplate();
                });

                // Close Error Toast
                document.getElementById('closeErrorToast').addEventListener('click', () => {
                    document.getElementById('errorToast').classList.remove('show');
                });

                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                ['attendanceDate', 'journalDate', 'reportStartDate', 'reportEndDate'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = today;
                });
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
        });
    </script>
</body>
</html>
