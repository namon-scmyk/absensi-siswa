<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Absensi Siswa - Dashboard Guru</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Absensi Siswa">
    <meta name="description" content="Aplikasi manajemen presensi siswa untuk guru. Kelola data siswa, input presensi, dan buat laporan dengan mudah.">
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... SEMUA STYLE ANDA TETAP SAMA ... */
        /* Tidak ada perubahan pada CSS — tetap pertahankan seperti aslinya */
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; }
        .touch-action-none { touch-action: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 640px) {
            .mobile-padding { padding: 1rem; }
            .mobile-text { font-size: 0.875rem; }
            .mobile-button { min-height: 44px; min-width: 44px; }
        }
        .touch-card {
            transform: scale(1);
            transition: transform 0.2s ease;
        }
        .touch-card:active {
            transform: scale(0.98);
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .online { background: #10b981; color: white; }
        .offline { background: #ef4444; color: white; }
        .connecting { background: #f59e0b; color: white; }
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        .splash-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        @media (max-width: 768px) {
            .mobile-full-width {
                width: 100% !important;
                max-width: 100% !important;
            }
            .mobile-stack {
                flex-direction: column !important;
            }
            .mobile-center {
                text-align: center !important;
            }
        }
        @supports (padding: max(0px)) {
            .safe-area-top {
                padding-top: max(env(safe-area-inset-top), 20px);
            }
            .safe-area-bottom {
                padding-bottom: max(env(safe-area-inset-bottom), 20px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- ... SEMUA HTML STRUKTUR ANDA TETAP SAMA ... -->
    <!-- Tidak ada perubahan pada HTML — hanya JavaScript yang diubah -->
    <!-- Copy-paste SEMUA HTML Anda dari <body> sampai sebelum <script> -->
    <!-- Saya asumsikan Anda sudah paste semua HTML di sini -->
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="spinner"></div>
                <span class="text-gray-700">Memproses...</span>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Berhasil!</span>
        </div>
    </div>

    <!-- SCRIPT UTAMA (YANG DIUBAH UNTUK SUPABASE) -->
    <script>
        // =============================
        // ✅ SUPABASE CLIENT SETUP
        // =============================
        const supabaseUrl = 'https://lleviwszkjhoyqvpiapu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZXZpd3N6a2pob3lxdnBpYXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MDc3MjcsImV4cCI6MjA3NDA4MzcyN30.YP6WYMiwJch6lhk2AiLUtUwyGZ5soO382MjqKD4jwg4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // =============================
        // 🧠 APPLICATION STATE & CONFIG
        // =============================
        const App = {
            config: {
                debug: true,
                chartColors: {
                    primary: '#3B82F6',
                    success: '#10B981',
                    warning: '#F59E0B',
                    danger: '#EF4444',
                    info: '#6366F1'
                },
                classOptions: ['X-1','X-2','X-3','X-4','X-5','X-6','X-7','X-8','X-9','X-10','X-11']
            },

            state: {
                currentView: 'dashboard',
                students: [],
                attendance: [],
                journal: [],
                isOnline: navigator.onLine,
                currentEditingStudent: null,
                studentToDelete: null,
                teacherProfile: {
                    id: null,
                    name: 'Guru',
                    subject: 'Mata Pelajaran',
                    nip: '',
                    email: '',
                    phone: '',
                    photo: null
                },
                charts: {
                    attendance: null,
                    classPerformance: null
                }
            },

            // =============================
            // 🚀 INIT & EVENT HANDLERS
            // =============================
            async init() {
                this.log('🚀 Initializing Supabase App...');
                this.setupEventListeners();
                this.setupResponsiveHandlers();
                await this.loadDataFromSupabase(); // ✅ Ganti localStorage dengan Supabase
                this.updateCurrentDate();
                this.updateConnectionStatus();
                this.loadTeacherProfile();
                this.showView('dashboard');
                setTimeout(() => this.hideSplashScreen(), 2000);
                this.log('✅ App initialized with Supabase!');
            },

            setupEventListeners() {
                // ... SEMUA EVENT LISTENER ANDA TETAP SAMA ...
                // Hanya fungsi handler yang akan dipanggil yang diubah ke async
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = e.currentTarget.getAttribute('href').substring(1);
                        this.showView(view);
                    });
                });
                document.querySelectorAll('.nav-mobile-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const view = btn.getAttribute('data-view');
                        this.showView(view);
                    });
                });
                document.querySelectorAll('.quick-action-btn').forEach((btn, index) => {
                    btn.addEventListener('click', () => {
                        const views = ['attendance', 'reports', 'students', 'journal'];
                        this.showView(views[index]);
                    });
                });
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (addStudentBtn) {
                    addStudentBtn.addEventListener('click', () => this.showAddStudentModal());
                }
                const saveStudent = document.getElementById('saveStudent');
                if (saveStudent) {
                    saveStudent.addEventListener('click', () => this.saveStudent());
                }
                const cancelStudent = document.getElementById('cancelStudent');
                if (cancelStudent) {
                    cancelStudent.addEventListener('click', () => this.hideStudentModal());
                }
                const closeStudentModal = document.getElementById('closeStudentModal');
                if (closeStudentModal) {
                    closeStudentModal.addEventListener('click', () => this.hideStudentModal());
                }
                const generateNIS = document.getElementById('generateNIS');
                if (generateNIS) {
                    generateNIS.addEventListener('click', () => this.generateNIS());
                }
                const classFilter = document.getElementById('classFilter');
                if (classFilter) {
                    classFilter.addEventListener('change', () => this.filterStudents());
                }
                const searchStudent = document.getElementById('searchStudent');
                if (searchStudent) {
                    searchStudent.addEventListener('input', () => this.filterStudents());
                }
                const cancelDelete = document.getElementById('cancelDelete');
                if (cancelDelete) {
                    cancelDelete.addEventListener('click', () => this.hideDeleteModal());
                }
                const confirmDelete = document.getElementById('confirmDelete');
                if (confirmDelete) {
                    confirmDelete.addEventListener('click', () => this.confirmDeleteStudent());
                }
                const teacherProfile = document.getElementById('teacherProfile');
                if (teacherProfile) {
                    teacherProfile.addEventListener('click', () => this.showTeacherProfileModal());
                }
                const profileBtn = document.getElementById('profileBtn');
                if (profileBtn) {
                    profileBtn.addEventListener('click', () => this.showTeacherProfileModal());
                }
                const saveTeacherProfile = document.getElementById('saveTeacherProfile');
                if (saveTeacherProfile) {
                    saveTeacherProfile.addEventListener('click', () => this.saveTeacherProfile());
                }
                const cancelTeacherProfile = document.getElementById('cancelTeacherProfile');
                if (cancelTeacherProfile) {
                    cancelTeacherProfile.addEventListener('click', () => this.hideTeacherProfileModal());
                }
                const closeTeacherModal = document.getElementById('closeTeacherModal');
                if (closeTeacherModal) {
                    closeTeacherModal.addEventListener('click', () => this.hideTeacherProfileModal());
                }
                const attendanceClass = document.getElementById('attendanceClass');
                if (attendanceClass) {
                    attendanceClass.addEventListener('change', () => this.loadStudentsForAttendance());
                }
                const saveAttendance = document.getElementById('saveAttendance');
                if (saveAttendance) {
                    saveAttendance.addEventListener('click', () => this.saveAttendance());
                }
                const addJournalBtn = document.getElementById('addJournalBtn');
                if (addJournalBtn) {
                    addJournalBtn.addEventListener('click', () => this.showJournalForm());
                }
                const saveJournal = document.getElementById('saveJournal');
                if (saveJournal) {
                    saveJournal.addEventListener('click', () => this.saveJournal());
                }
                const cancelJournal = document.getElementById('cancelJournal');
                if (cancelJournal) {
                    cancelJournal.addEventListener('click', () => this.hideJournalForm());
                }
                const generateReport = document.getElementById('generateReport');
                if (generateReport) {
                    generateReport.addEventListener('click', () => this.generateReport());
                }
                const importStudentsBtn = document.getElementById('importStudentsBtn');
                if (importStudentsBtn) {
                    importStudentsBtn.addEventListener('click', () => this.showImportModal());
                }
                const exportStudentsBtn = document.getElementById('exportStudentsBtn');
                if (exportStudentsBtn) {
                    exportStudentsBtn.addEventListener('click', () => this.exportStudentsData());
                }
                const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
                if (downloadTemplateBtn) {
                    downloadTemplateBtn.addEventListener('click', () => this.downloadTemplate());
                }
                const today = new Date().toISOString().split('T')[0];
                const attendanceDate = document.getElementById('attendanceDate');
                if (attendanceDate) attendanceDate.value = today;
                const journalDate = document.getElementById('journalDate');
                if (journalDate) journalDate.value = today;
                const reportStartDate = document.getElementById('reportStartDate');
                if (reportStartDate) reportStartDate.value = today;
                const reportEndDate = document.getElementById('reportEndDate');
                if (reportEndDate) reportEndDate.value = today;
            },

            setupResponsiveHandlers() {
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        if (window.Chart) {
                            Chart.helpers.each(Chart.instances, (instance) => {
                                instance.resize();
                            });
                        }
                    }, 500);
                });
                window.addEventListener('online', () => {
                    this.state.isOnline = true;
                    this.updateConnectionStatus();
                });
                window.addEventListener('offline', () => {
                    this.state.isOnline = false;
                    this.updateConnectionStatus();
                });
                this.updateViewportHeight();
                window.addEventListener('resize', () => this.updateViewportHeight());
            },

            updateViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            },

            // =============================
            // 🌐 SUPABASE DATA HANDLERS (PENGANTI LOCALSTORAGE)
            // =============================

            async loadDataFromSupabase() {
                this.showLoading(true);
                try {
                    // Load Students from Supabase
                    let { data: students, error: studentsError } = await supabase
                        .from('students')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (studentsError) throw studentsError;
                    this.state.students = students || [];
                    this.log('✅ Loaded students from Supabase:', this.state.students.length);

                    // Load Attendance (placeholder — Anda bisa buat tabel attendance nanti)
                    this.state.attendance = [];
                    // Load Journal (placeholder)
                    this.state.journal = [];

                    this.updateStudentsStats();
                    this.showToast('Data berhasil dimuat dari server!', 'success');

                } catch (error) {
                    this.log('❌ Error loading from Supabase:', error.message);
                    this.showToast('Gagal memuat data dari server. Coba lagi nanti.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            async saveStudentToSupabase(studentData) {
                try {
                    let result;
                    if (this.state.currentEditingStudent) {
                        // UPDATE
                        result = await supabase
                            .from('students')
                            .update(studentData)
                            .eq('id', this.state.currentEditingStudent.id)
                            .select();
                    } else {
                        // INSERT
                        result = await supabase
                            .from('students')
                            .insert([studentData])
                            .select();
                    }

                    if (result.error) throw result.error;

                    await this.loadDataFromSupabase(); // Refresh data
                    return result.data[0];

                } catch (error) {
                    this.log('❌ Error saving student:', error.message);
                    this.showToast('Gagal menyimpan data siswa ke server.', 'error');
                    return null;
                }
            },

            async deleteStudentFromSupabase(studentId) {
                try {
                    const { error } = await supabase
                        .from('students')
                        .delete()
                        .eq('id', studentId);

                    if (error) throw error;

                    await this.loadDataFromSupabase(); // Refresh data
                    this.showToast('Siswa berhasil dihapus dari server!', 'success');

                } catch (error) {
                    this.log('❌ Error deleting student:', error.message);
                    this.showToast('Gagal menghapus siswa dari server.', 'error');
                }
            },

            // =============================
            // 🔄 UI UPDATE FUNCTIONS (TERINTEGRASI DENGAN SUPABASE)
            // =============================

            showAddStudentModal() {
                this.state.currentEditingStudent = null;
                const studentModalTitle = document.getElementById('studentModalTitle');
                if (studentModalTitle) studentModalTitle.textContent = 'Tambah Siswa Baru';
                const saveStudent = document.getElementById('saveStudent');
                if (saveStudent) saveStudent.textContent = 'Simpan Siswa';
                this.resetStudentForm();
                const studentModal = document.getElementById('studentModal');
                if (studentModal) studentModal.classList.remove('hidden');
            },

            editStudent(studentId) {
                const student = this.state.students.find(s => s.id === studentId);
                if (!student) return;
                this.state.currentEditingStudent = student;
                const studentModalTitle = document.getElementById('studentModalTitle');
                if (studentModalTitle) studentModalTitle.textContent = 'Edit Data Siswa';
                const saveStudent = document.getElementById('saveStudent');
                if (saveStudent) saveStudent.textContent = 'Update Siswa';
                const studentNIS = document.getElementById('studentNIS');
                if (studentNIS) studentNIS.value = student.nis || '';
                const studentName = document.getElementById('studentName');
                if (studentName) studentName.value = student.name || '';
                const studentClass = document.getElementById('studentClass');
                if (studentClass) studentClass.value = student.class || '';
                const studentGender = document.getElementById('studentGender');
                if (studentGender) studentGender.value = student.gender || '';
                const studentPhone = document.getElementById('studentPhone');
                if (studentPhone) studentPhone.value = student.phone || '';
                const studentAddress = document.getElementById('studentAddress');
                if (studentAddress) studentAddress.value = student.address || '';
                const studentParentName = document.getElementById('studentParentName');
                if (studentParentName) studentParentName.value = student.parent_name || '';
                const studentParentPhone = document.getElementById('studentParentPhone');
                if (studentParentPhone) studentParentPhone.value = student.parent_phone || '';
                const studentModal = document.getElementById('studentModal');
                if (studentModal) studentModal.classList.remove('hidden');
            },

            async saveStudent() {
                const studentNIS = document.getElementById('studentNIS');
                const studentName = document.getElementById('studentName');
                const studentClass = document.getElementById('studentClass');
                const studentGender = document.getElementById('studentGender');
                const studentPhone = document.getElementById('studentPhone');
                const studentAddress = document.getElementById('studentAddress');
                const studentParentName = document.getElementById('studentParentName');
                const studentParentPhone = document.getElementById('studentParentPhone');

                const formData = {
                    nis: studentNIS ? studentNIS.value.trim() : '',
                    name: studentName ? studentName.value.trim() : '',
                    class: studentClass ? studentClass.value : '',
                    gender: studentGender ? studentGender.value : '',
                    phone: studentPhone ? studentPhone.value.trim() : '',
                    address: studentAddress ? studentAddress.value.trim() : '',
                    parent_name: studentParentName ? studentParentName.value.trim() : '',
                    parent_phone: studentParentPhone ? studentParentPhone.value.trim() : ''
                };

                // Validation
                if (!formData.nis || !formData.name || !formData.class || !formData.gender) {
                    this.showToast('Mohon lengkapi semua field yang wajib (*)', 'error');
                    return;
                }
                if (!/^\d{5}$/.test(formData.nis)) {
                    this.showToast('Format NIS harus 5 digit angka', 'error');
                    return;
                }

                // Check duplicate NIS (di Supabase)
                const { data: existing, error: checkError } = await supabase
                    .from('students')
                    .select('id')
                    .eq('nis', formData.nis)
                    .neq('id', this.state.currentEditingStudent?.id || '');

                if (checkError) {
                    this.log('Error checking duplicate:', checkError);
                    this.showToast('Gagal memeriksa duplikat NIS.', 'error');
                    return;
                }
                if (existing && existing.length > 0) {
                    this.showToast('NIS sudah digunakan', 'error');
                    return;
                }

                this.showLoading(true);
                const savedStudent = await this.saveStudentToSupabase(formData);
                this.showLoading(false);

                if (savedStudent) {
                    this.hideStudentModal();
                    this.showToast(this.state.currentEditingStudent ? 'Data siswa berhasil diupdate!' : 'Siswa berhasil ditambahkan!', 'success');
                }
            },

            deleteStudent(studentId) {
                const student = this.state.students.find(s => s.id === studentId);
                if (!student) return;
                this.state.studentToDelete = student;
                const deleteModal = document.getElementById('deleteModal');
                if (deleteModal) deleteModal.classList.remove('hidden');
            },

            async confirmDeleteStudent() {
                if (!this.state.studentToDelete) return;
                this.showLoading(true);
                await this.deleteStudentFromSupabase(this.state.studentToDelete.id);
                this.showLoading(false);
                this.hideDeleteModal();
            },

            filterStudents() {
                const classFilter = document.getElementById('classFilter');
                const searchStudent = document.getElementById('searchStudent');
                const classValue = classFilter ? classFilter.value : '';
                const searchTerm = searchStudent ? searchStudent.value.toLowerCase() : '';
                let filteredStudents = this.state.students;
                if (classValue) {
                    filteredStudents = filteredStudents.filter(student => student.class === classValue);
                }
                if (searchTerm) {
                    filteredStudents = filteredStudents.filter(student => 
                        student.name.toLowerCase().includes(searchTerm) || 
                        student.nis.includes(searchTerm)
                    );
                }
                this.renderStudentsTable(filteredStudents);
            },

            loadStudentsData() {
                this.renderStudentsTable(this.state.students);
            },

            renderStudentsTable(students) {
                const tbody = document.getElementById('studentsTableBody');
                if (!tbody) return;

                if (students.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="p-8">
                                <div class="empty-state">
                                    <i class="fas fa-users empty-state-icon"></i>
                                    <h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Data Siswa</h4>
                                    <p class="text-gray-500 mb-4">Mulai dengan menambahkan siswa baru atau import data dari Excel.</p>
                                    <button onclick="document.getElementById('addStudentBtn').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Tambah Siswa Pertama
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = students.slice(0, 50).map(student => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-4 font-medium text-gray-900">${student.nis}</td>
                        <td class="p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium text-blue-600">${student.name.charAt(0)}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-900">${student.name}</span>
                                    ${student.gender ? `<p class="text-xs text-gray-500">${student.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${student.class}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${student.attendance_rate || 0}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">${student.attendance_rate || 0}%</span>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="flex space-x-2">
                                <button onclick="App.editStudent('${student.id}')" class="text-blue-600 hover:text-blue-800 transition-colors mobile-button" title="Edit Data">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="App.editStudentClass('${student.id}')" class="text-purple-600 hover:text-purple-800 transition-colors mobile-button" title="Edit Kelas">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button onclick="App.deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 transition-colors mobile-button" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            // =============================
            // 🧩 HELPER FUNCTIONS (TETAP SAMA)
            // =============================

            log(...args) {
                if (this.config.debug) {
                    console.log('[APP]', ...args);
                }
            },

            showLoading(show) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.toggle('hidden', !show);
                }
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                if (!toast || !toastMessage) return;

                toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50';
                switch (type) {
                    case 'success':
                        toast.classList.add('bg-green-500', 'text-white');
                        toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas fa-check-circle"></i><span>${message}</span></div>`;
                        break;
                    case 'error':
                        toast.classList.add('bg-red-500', 'text-white');
                        toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas fa-exclamation-circle"></i><span>${message}</span></div>`;
                        break;
                    case 'warning':
                        toast.classList.add('bg-yellow-500', 'text-white');
                        toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas fa-exclamation-triangle"></i><span>${message}</span></div>`;
                        break;
                    case 'info':
                        toast.classList.add('bg-blue-500', 'text-white');
                        toast.innerHTML = `<div class="flex items-center space-x-2"><i class="fas fa-info-circle"></i><span>${message}</span></div>`;
                        break;
                }

                setTimeout(() => toast.classList.remove('translate-x-full'), 100);
                setTimeout(() => toast.classList.add('translate-x-full'), 3000);
            },

            hideSplashScreen() {
                const splashScreen = document.getElementById('splashScreen');
                if (splashScreen) {
                    splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 300);
                }
            },

            resetStudentForm() {
                const studentForm = document.getElementById('studentForm');
                if (studentForm) studentForm.reset();
            },

            generateNIS() {
                const studentClass = document.getElementById('studentClass');
                if (!studentClass || !studentClass.value) {
                    this.showToast('Pilih kelas terlebih dahulu', 'error');
                    return;
                }
                const classStudents = this.state.students.filter(s => s.class === studentClass.value);
                const nextNumber = (classStudents.length + 1).toString();
                const nis = nextNumber.padStart(5, '0');
                const studentNIS = document.getElementById('studentNIS');
                if (studentNIS) studentNIS.value = nis;
            },

            updateStudentsStats() {
                const totalStudents = this.state.students.length;
                const totalStudentsEl = document.getElementById('totalStudents');
                if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
                // Placeholder stats — bisa dikembangkan
                document.getElementById('presentToday')?.textContent = '0';
                document.getElementById('absentToday')?.textContent = '0';
                document.getElementById('excusedToday')?.textContent = '0';
            },

            updateCurrentDate() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = now.toLocaleDateString('id-ID', options);
                const dateEl = document.getElementById('currentDate');
                if (dateEl) dateEl.textContent = dateStr;
            },

            updateConnectionStatus() {
                const statusEl = document.getElementById('connectionStatus');
                if (!statusEl) return;
                if (this.state.isOnline) {
                    statusEl.className = 'connection-status online';
                    statusEl.innerHTML = '<i class="fas fa-wifi mr-1"></i><span>Online</span>';
                } else {
                    statusEl.className = 'connection-status offline';
                    statusEl.innerHTML = '<i class="fas fa-wifi mr-1"></i><span>Offline Mode</span>';
                }
            },

            showView(viewName) {
                document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
                const selectedView = document.getElementById(viewName + 'View');
                if (selectedView) selectedView.classList.remove('hidden');
                this.updateNavigationState(viewName);
                this.state.currentView = viewName;
                if (viewName === 'students') this.loadStudentsData();
                if (viewName === 'dashboard') this.setupCharts();
            },

            updateNavigationState(activeView) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
                    item.classList.add('text-gray-600');
                });
                const activeDesktopNav = document.querySelector(`[href="#${activeView}"]`);
                if (activeDesktopNav) {
                    activeDesktopNav.classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
                    activeDesktopNav.classList.remove('text-gray-600');
                }
                document.querySelectorAll('.nav-mobile-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-gray-400');
                });
                const activeMobileNav = document.querySelector(`[data-view="${activeView}"]`);
                if (activeMobileNav) {
                    activeMobileNav.classList.add('text-blue-600');
                    activeMobileNav.classList.remove('text-gray-400');
                }
            },

            setupCharts() {
                setTimeout(() => {
                    if (this.state.charts.attendance) this.state.charts.attendance.destroy();
                    if (this.state.charts.classPerformance) this.state.charts.classPerformance.destroy();
                    const attendanceCtx = document.getElementById('attendanceChart');
                    if (attendanceCtx && typeof Chart !== 'undefined') {
                        this.state.charts.attendance = new Chart(attendanceCtx, {
                            type: 'line',
                            data: {
                                labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum'],
                                datasets: [{
                                    label: 'Kehadiran (%)',
                                    data: [0, 0, 0, 0, 0],
                                    borderColor: this.config.chartColors.primary,
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    pointBackgroundColor: this.config.chartColors.primary,
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: { callback: v => v + '%' }
                                    }
                                }
                            }
                        });
                    }
                    const classCtx = document.getElementById('classChart');
                    if (classCtx && typeof Chart !== 'undefined') {
                        this.state.charts.classPerformance = new Chart(classCtx, {
                            type: 'bar',
                            data: {
                                labels: ['X-1','X-2','X-3','X-4','X-5','X-6','X-7','X-8','X-9','X-10','X-11'],
                                datasets: [{
                                    label: 'Rata-rata Kehadiran (%)',
                                    data: Array(11).fill(0),
                                    backgroundColor: [
                                        '#10B981','#3B82F6','#6366F1','#F59E0B','#EF4444',
                                        '#6B7280','#4F46E5','#0891B2','#65A30D','#B91C1C','#9333EA'
                                    ],
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: { callback: v => v + '%' }
                                    }
                                }
                            }
                        });
                    }
                }, 500);
            },

            // Untuk fungsi lain (attendance, journal, reports, import/export, teacher profile) —
            // Anda bisa tetap gunakan versi localStorage sementara, atau saya bantu ubah ke Supabase juga.
            // Beri tahu saya jika butuh bantuan untuk bagian lainnya.

            hideStudentModal() {
                const studentModal = document.getElementById('studentModal');
                if (studentModal) studentModal.classList.add('hidden');
                this.resetStudentForm();
                this.state.currentEditingStudent = null;
            },

            hideDeleteModal() {
                const deleteModal = document.getElementById('deleteModal');
                if (deleteModal) deleteModal.classList.add('hidden');
                this.state.studentToDelete = null;
            },

            editStudentClass(studentId) {
                const student = this.state.students.find(s => s.id === studentId);
                if (!student) return;
                const newClass = prompt(`Pindahkan ${student.name} dari kelas ${student.class} ke kelas:
X-1, X-2, X-3, X-4, X-5, X-6, X-7, X-8, X-9, X-10, X-11`, student.class);
                if (!newClass) return;
                if (!this.config.classOptions.includes(newClass)) {
                    this.showToast('Kelas tidak valid!', 'error');
                    return;
                }
                this.showLoading(true);
                const { error } = await supabase
                    .from('students')
                    .update({ class: newClass })
                    .eq('id', studentId);
                if (error) {
                    this.showToast('Gagal memperbarui kelas.', 'error');
                } else {
                    await this.loadDataFromSupabase();
                    this.showToast(`${student.name} berhasil dipindahkan ke kelas ${newClass}!`, 'success');
                }
                this.showLoading(false);
            },

            loadTeacherProfile() {
                // Placeholder — bisa dikembangkan
                const teacherName = document.getElementById('teacherName');
                if (teacherName) teacherName.textContent = this.state.teacherProfile.name;
                const teacherSubject = document.getElementById('teacherSubject');
                if (teacherSubject) teacherSubject.textContent = this.state.teacherProfile.subject;
            },

            showTeacherProfileModal() {
                // Placeholder
                const teacherProfileModal = document.getElementById('teacherProfileModal');
                if (teacherProfileModal) teacherProfileModal.classList.remove('hidden');
            },

            hideTeacherProfileModal() {
                const teacherProfileModal = document.getElementById('teacherProfileModal');
                if (teacherProfileModal) teacherProfileModal.classList.add('hidden');
            },

            saveTeacherProfile() {
                // Placeholder — bisa dikembangkan
                this.showToast('Fitur profil guru akan dikembangkan nanti.', 'info');
                this.hideTeacherProfileModal();
            },

            loadStudentsForAttendance() {
                const attendanceClass = document.getElementById('attendanceClass');
                const container = document.getElementById('attendanceStudentsList');
                const saveBtn = document.getElementById('saveAttendance');
                const selectedClass = attendanceClass ? attendanceClass.value : '';
                if (!selectedClass) {
                    if (container) container.innerHTML = `<div class="empty-state"><i class="fas fa-clipboard-list empty-state-icon"></i><h4 class="text-lg font-medium text-gray-900 mb-2">Pilih Kelas</h4><p class="text-gray-500">Pilih kelas dari dropdown di atas untuk menampilkan daftar siswa dan mulai input presensi.</p></div>`;
                    if (saveBtn) saveBtn.disabled = true;
                    return;
                }
                const classStudents = this.state.students.filter(student => student.class === selectedClass);
                if (classStudents.length === 0) {
                    if (container) container.innerHTML = `<div class="empty-state"><i class="fas fa-users empty-state-icon"></i><h4 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Siswa</h4><p class="text-gray-500 mb-4">Belum ada siswa di kelas ${selectedClass}. Tambahkan siswa terlebih dahulu.</p><button onclick="App.showView('students')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-all"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button></div>`;
                    if (saveBtn) saveBtn.disabled = true;
                    return;
                }
                if (container) {
                    container.innerHTML = `<div class="grid grid-cols-1 gap-3">${classStudents.map(student => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-sm font-medium text-blue-600">${student.name.charAt(0)}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">${student.name}</p>
                                    <p class="text-sm text-gray-500">${student.nis}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="radio" name="attendance_${student.id}" value="present" class="text-green-500 focus:ring-green-500">
                                    <span class="text-sm text-green-600">Hadir</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="radio" name="attendance_${student.id}" value="absent" class="text-red-500 focus:ring-red-500">
                                    <span class="text-sm text-red-600">Tidak</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer">
                                    <input type="radio" name="attendance_${student.id}" value="excused" class="text-yellow-500 focus:ring-yellow-500">
                                    <span class="text-sm text-yellow-600">Izin</span>
                                </label>
                            </div>
                        </div>
                    `).join('')}</div>`;
                }
                if (saveBtn) saveBtn.disabled = false;
            },

            saveAttendance() {
                this.showToast('Fitur presensi akan dikembangkan nanti.', 'info');
            },

            showJournalForm() {
                this.showToast('Fitur jurnal akan dikembangkan nanti.', 'info');
            },

            hideJournalForm() {},

            saveJournal() {},

            loadJournalData() {
                const container = document.getElementById('journalList');
                if (container) container.innerHTML = `<div class="p-6"><div class="empty-state"><i class="fas fa-book empty-state-icon"></i><h4 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Jurnal</h4><p class="text-gray-500 mb-4">Fitur jurnal akan segera dikembangkan.</p></div></div>`;
            },

            generateReport() {
                this.showToast('Fitur laporan akan dikembangkan nanti.', 'info');
            },

            showImportModal() {
                this.showToast('Fitur import akan dikembangkan nanti.', 'info');
            },

            hideImportModal() {},

            exportStudentsData() {
                this.showToast('Fitur export akan dikembangkan nanti.', 'info');
            },

            downloadTemplate() {
                this.showToast('Fitur template akan dikembangkan nanti.', 'info');
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Make App globally accessible
        window.App = App;

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
